"""Add order book models
Revision ID: 4dfb99055368
Revises: c2e1da5453c0
Create Date: 2025-10-27 22:27:59.717048
"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql
# revision identifiers, used by Alembic.
revision = '4dfb99055368'
down_revision = 'c2e1da5453c0'
branch_labels = None
depends_on = None
def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('plugin_registry',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('slug', sa.String(length=255), nullable=False),
    sa.Column('name', sa.String(length=255), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('category', sa.String(length=100), nullable=False),
    sa.Column('tags', sa.JSON(), nullable=True),
    sa.Column('latest_version', sa.String(length=50), nullable=False),
    sa.Column('available_versions', sa.JSON(), nullable=True),
    sa.Column('download_url', sa.String(length=1000), nullable=True),
    sa.Column('repository_url', sa.String(length=1000), nullable=True),
    sa.Column('author', sa.String(length=255), nullable=True),
    sa.Column('license', sa.String(length=100), nullable=True),
    sa.Column('homepage_url', sa.String(length=1000), nullable=True),
    sa.Column('rating', sa.JSON(), nullable=True),
    sa.Column('download_count', sa.Integer(), nullable=False),
    sa.Column('verified', sa.Boolean(), nullable=False),
    sa.Column('active', sa.Boolean(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_registry_category', 'plugin_registry', ['category'], unique=False)
    op.create_index('idx_registry_verified', 'plugin_registry', ['verified'], unique=False)
    op.create_index(op.f('ix_plugin_registry_category'), 'plugin_registry', ['category'], unique=False)
    op.create_index(op.f('ix_plugin_registry_id'), 'plugin_registry', ['id'], unique=False)
    op.create_index(op.f('ix_plugin_registry_slug'), 'plugin_registry', ['slug'], unique=True)
    op.create_table('ai_agents',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('organization_id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=255), nullable=False),
    sa.Column('agent_type', sa.String(length=50), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('status', sa.String(length=50), nullable=False),
    sa.Column('version', sa.String(length=50), nullable=False),
    sa.Column('capabilities', sa.JSON(), nullable=True),
    sa.Column('endpoint_url', sa.String(length=1000), nullable=True),
    sa.Column('api_key', sa.String(length=255), nullable=True),
    sa.Column('config', sa.JSON(), nullable=True),
    sa.Column('parameters', sa.JSON(), nullable=True),
    sa.Column('total_requests', sa.Integer(), nullable=False),
    sa.Column('successful_requests', sa.Integer(), nullable=False),
    sa.Column('failed_requests', sa.Integer(), nullable=False),
    sa.Column('average_response_time', sa.Float(), nullable=True),
    sa.Column('last_used_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], name='fk_ai_agent_organization_id'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_ai_agent_org_type', 'ai_agents', ['organization_id', 'agent_type'], unique=False)
    op.create_index('idx_ai_agent_status', 'ai_agents', ['status'], unique=False)
    op.create_index(op.f('ix_ai_agents_id'), 'ai_agents', ['id'], unique=False)
    op.create_index(op.f('ix_ai_agents_name'), 'ai_agents', ['name'], unique=False)
    op.create_index(op.f('ix_ai_agents_organization_id'), 'ai_agents', ['organization_id'], unique=False)
    op.create_table('ledger_summaries',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('organization_id', sa.Integer(), nullable=False),
    sa.Column('summary_date', sa.Date(), nullable=False),
    sa.Column('period_type', sa.String(), nullable=False),
    sa.Column('total_debit', sa.Numeric(precision=15, scale=2), nullable=False),
    sa.Column('total_credit', sa.Numeric(precision=15, scale=2), nullable=False),
    sa.Column('net_balance', sa.Numeric(precision=15, scale=2), nullable=False),
    sa.Column('transaction_count', sa.Integer(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('organization_id', 'summary_date', 'period_type', name='uq_ledger_summary_org_date_period')
    )
    op.create_index(op.f('ix_ledger_summaries_id'), 'ledger_summaries', ['id'], unique=False)
    op.create_index(op.f('ix_ledger_summaries_organization_id'), 'ledger_summaries', ['organization_id'], unique=False)
    op.create_index(op.f('ix_ledger_summaries_summary_date'), 'ledger_summaries', ['summary_date'], unique=False)
    op.create_table('plugins',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('organization_id', sa.Integer(), nullable=True),
    sa.Column('name', sa.String(length=255), nullable=False),
    sa.Column('slug', sa.String(length=255), nullable=False),
    sa.Column('version', sa.String(length=50), nullable=False),
    sa.Column('plugin_type', sa.String(length=50), nullable=False),
    sa.Column('scope', sa.String(length=50), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('author', sa.String(length=255), nullable=True),
    sa.Column('homepage_url', sa.String(length=1000), nullable=True),
    sa.Column('documentation_url', sa.String(length=1000), nullable=True),
    sa.Column('status', sa.String(length=50), nullable=False),
    sa.Column('enabled', sa.Boolean(), nullable=False),
    sa.Column('entry_point', sa.String(length=500), nullable=True),
    sa.Column('assets_path', sa.String(length=500), nullable=True),
    sa.Column('config', sa.JSON(), nullable=True),
    sa.Column('default_settings', sa.JSON(), nullable=True),
    sa.Column('dependencies', sa.JSON(), nullable=True),
    sa.Column('min_platform_version', sa.String(length=50), nullable=True),
    sa.Column('max_platform_version', sa.String(length=50), nullable=True),
    sa.Column('required_permissions', sa.JSON(), nullable=True),
    sa.Column('sandboxed', sa.Boolean(), nullable=False),
    sa.Column('install_count', sa.Integer(), nullable=False),
    sa.Column('last_installed_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], name='fk_plugin_organization_id'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_plugin_org_type', 'plugins', ['organization_id', 'plugin_type'], unique=False)
    op.create_index('idx_plugin_scope', 'plugins', ['scope'], unique=False)
    op.create_index('idx_plugin_status', 'plugins', ['status'], unique=False)
    op.create_index(op.f('ix_plugins_id'), 'plugins', ['id'], unique=False)
    op.create_index(op.f('ix_plugins_name'), 'plugins', ['name'], unique=False)
    op.create_index(op.f('ix_plugins_organization_id'), 'plugins', ['organization_id'], unique=False)
    op.create_index(op.f('ix_plugins_slug'), 'plugins', ['slug'], unique=True)
    op.create_table('ab_test_experiments',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('organization_id', sa.Integer(), nullable=False),
    sa.Column('experiment_name', sa.String(length=255), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('status', sa.Enum('DRAFT', 'RUNNING', 'PAUSED', 'COMPLETED', 'ARCHIVED', name='experimentstatus'), nullable=False),
    sa.Column('traffic_split', sa.JSON(), nullable=True),
    sa.Column('start_date', sa.DateTime(timezone=True), nullable=True),
    sa.Column('end_date', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_by_id', sa.Integer(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['created_by_id'], ['users.id'], name='fk_ab_test_created_by'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], name='fk_ab_test_org_id'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_ab_test_dates', 'ab_test_experiments', ['start_date', 'end_date'], unique=False)
    op.create_index('idx_ab_test_org_status', 'ab_test_experiments', ['organization_id', 'status'], unique=False)
    op.create_index(op.f('ix_ab_test_experiments_id'), 'ab_test_experiments', ['id'], unique=False)
    op.create_index(op.f('ix_ab_test_experiments_organization_id'), 'ab_test_experiments', ['organization_id'], unique=False)
    op.create_index(op.f('ix_ab_test_experiments_status'), 'ab_test_experiments', ['status'], unique=False)
    op.create_table('ai_agent_capabilities',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('agent_id', sa.Integer(), nullable=False),
    sa.Column('capability_name', sa.String(length=100), nullable=False),
    sa.Column('capability_type', sa.String(length=50), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('enabled', sa.Boolean(), nullable=False),
    sa.Column('config', sa.JSON(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['agent_id'], ['ai_agents.id'], name='fk_ai_capability_agent_id'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_ai_capability_agent', 'ai_agent_capabilities', ['agent_id'], unique=False)
    op.create_index(op.f('ix_ai_agent_capabilities_agent_id'), 'ai_agent_capabilities', ['agent_id'], unique=False)
    op.create_index(op.f('ix_ai_agent_capabilities_id'), 'ai_agent_capabilities', ['id'], unique=False)
    op.create_table('ai_agent_interactions',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('organization_id', sa.Integer(), nullable=False),
    sa.Column('agent_id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=True),
    sa.Column('interaction_type', sa.String(length=100), nullable=False),
    sa.Column('request_data', sa.JSON(), nullable=True),
    sa.Column('response_data', sa.JSON(), nullable=True),
    sa.Column('response_time_ms', sa.Integer(), nullable=True),
    sa.Column('success', sa.Boolean(), nullable=False),
    sa.Column('error_message', sa.Text(), nullable=True),
    sa.Column('session_id', sa.String(length=255), nullable=True),
    sa.Column('ip_address', sa.String(length=100), nullable=True),
    sa.Column('user_agent', sa.String(length=500), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['agent_id'], ['ai_agents.id'], name='fk_ai_interaction_agent_id'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], name='fk_ai_interaction_organization_id'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='fk_ai_interaction_user_id'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_ai_interaction_created', 'ai_agent_interactions', ['created_at'], unique=False)
    op.create_index('idx_ai_interaction_org_agent', 'ai_agent_interactions', ['organization_id', 'agent_id'], unique=False)
    op.create_index('idx_ai_interaction_session', 'ai_agent_interactions', ['session_id'], unique=False)
    op.create_index(op.f('ix_ai_agent_interactions_agent_id'), 'ai_agent_interactions', ['agent_id'], unique=False)
    op.create_index(op.f('ix_ai_agent_interactions_id'), 'ai_agent_interactions', ['id'], unique=False)
    op.create_index(op.f('ix_ai_agent_interactions_organization_id'), 'ai_agent_interactions', ['organization_id'], unique=False)
    op.create_index(op.f('ix_ai_agent_interactions_session_id'), 'ai_agent_interactions', ['session_id'], unique=False)
    op.create_index(op.f('ix_ai_agent_interactions_user_id'), 'ai_agent_interactions', ['user_id'], unique=False)
    op.create_table('anomaly_detection_models',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('organization_id', sa.Integer(), nullable=False),
    sa.Column('detection_name', sa.String(), nullable=False),
    sa.Column('anomaly_type', sa.Enum('REVENUE_ANOMALY', 'INVENTORY_ANOMALY', 'TRANSACTION_ANOMALY', 'CUSTOMER_BEHAVIOR_ANOMALY', 'OPERATIONAL_ANOMALY', 'QUALITY_ANOMALY', name='anomalytype'), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('algorithm', sa.String(), nullable=False),
    sa.Column('detection_config', sa.JSON(), nullable=False),
    sa.Column('threshold_config', sa.JSON(), nullable=False),
    sa.Column('monitored_metrics', sa.JSON(), nullable=False),
    sa.Column('detection_frequency', sa.String(), nullable=False),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('last_detection_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('anomalies_detected_count', sa.Integer(), nullable=False),
    sa.Column('created_by_id', sa.Integer(), nullable=False),
    sa.Column('updated_by_id', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['created_by_id'], ['users.id'], name='fk_anomaly_model_created_by'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], name='fk_anomaly_model_org_id'),
    sa.ForeignKeyConstraint(['updated_by_id'], ['users.id'], name='fk_anomaly_model_updated_by'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('organization_id', 'detection_name', name='uq_anomaly_model_org_name')
    )
    op.create_index('idx_anomaly_model_active', 'anomaly_detection_models', ['organization_id', 'is_active'], unique=False)
    op.create_index('idx_anomaly_model_org_type', 'anomaly_detection_models', ['organization_id', 'anomaly_type'], unique=False)
    op.create_index(op.f('ix_anomaly_detection_models_anomaly_type'), 'anomaly_detection_models', ['anomaly_type'], unique=False)
    op.create_index(op.f('ix_anomaly_detection_models_detection_name'), 'anomaly_detection_models', ['detection_name'], unique=False)
    op.create_index(op.f('ix_anomaly_detection_models_id'), 'anomaly_detection_models', ['id'], unique=False)
    op.create_index(op.f('ix_anomaly_detection_models_organization_id'), 'anomaly_detection_models', ['organization_id'], unique=False)
    op.create_table('audit_log_exports',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('organization_id', sa.Integer(), nullable=False),
    sa.Column('requested_by', sa.Integer(), nullable=False),
    sa.Column('start_date', sa.DateTime(timezone=True), nullable=True),
    sa.Column('end_date', sa.DateTime(timezone=True), nullable=True),
    sa.Column('filters', sa.JSON(), nullable=True),
    sa.Column('format', sa.String(length=50), nullable=False),
    sa.Column('include_metadata', sa.Boolean(), nullable=False),
    sa.Column('status', sa.String(length=50), nullable=False),
    sa.Column('record_count', sa.Integer(), nullable=True),
    sa.Column('file_path', sa.String(length=500), nullable=True),
    sa.Column('file_size_bytes', sa.Integer(), nullable=True),
    sa.Column('download_url', sa.String(length=1000), nullable=True),
    sa.Column('expires_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('error_message', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('completed_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], name='fk_audit_export_organization_id'),
    sa.ForeignKeyConstraint(['requested_by'], ['users.id'], name='fk_audit_export_user_id'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_audit_export_org_status', 'audit_log_exports', ['organization_id', 'status'], unique=False)
    op.create_index('idx_audit_export_user', 'audit_log_exports', ['requested_by'], unique=False)
    op.create_index(op.f('ix_audit_log_exports_id'), 'audit_log_exports', ['id'], unique=False)
    op.create_index(op.f('ix_audit_log_exports_organization_id'), 'audit_log_exports', ['organization_id'], unique=False)
    op.create_table('audit_log_views',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('organization_id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=255), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('entity_types', sa.JSON(), nullable=True),
    sa.Column('action_types', sa.JSON(), nullable=True),
    sa.Column('actor_types', sa.JSON(), nullable=True),
    sa.Column('severity_levels', sa.JSON(), nullable=True),
    sa.Column('columns', sa.JSON(), nullable=True),
    sa.Column('sort_order', sa.JSON(), nullable=True),
    sa.Column('created_by', sa.Integer(), nullable=False),
    sa.Column('shared', sa.Boolean(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['created_by'], ['users.id'], name='fk_audit_view_user_id'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], name='fk_audit_view_organization_id'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_audit_view_org', 'audit_log_views', ['organization_id'], unique=False)
    op.create_index('idx_audit_view_user', 'audit_log_views', ['created_by'], unique=False)
    op.create_index(op.f('ix_audit_log_views_id'), 'audit_log_views', ['id'], unique=False)
    op.create_index(op.f('ix_audit_log_views_organization_id'), 'audit_log_views', ['organization_id'], unique=False)
    op.create_table('audit_logs_enhanced',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('organization_id', sa.Integer(), nullable=True),
    sa.Column('entity_type', sa.String(length=100), nullable=False),
    sa.Column('entity_id', sa.Integer(), nullable=True),
    sa.Column('entity_name', sa.String(length=255), nullable=True),
    sa.Column('action', sa.String(length=50), nullable=False),
    sa.Column('action_description', sa.Text(), nullable=True),
    sa.Column('user_id', sa.Integer(), nullable=True),
    sa.Column('actor_type', sa.String(length=50), nullable=False),
    sa.Column('actor_id', sa.Integer(), nullable=True),
    sa.Column('actor_name', sa.String(length=255), nullable=True),
    sa.Column('ai_agent_id', sa.Integer(), nullable=True),
    sa.Column('automation_workflow_id', sa.Integer(), nullable=True),
    sa.Column('triggered_by_automation', sa.Boolean(), nullable=False),
    sa.Column('changes', sa.JSON(), nullable=True),
    sa.Column('old_values', sa.JSON(), nullable=True),
    sa.Column('new_values', sa.JSON(), nullable=True),
    sa.Column('context', sa.JSON(), nullable=True),
    sa.Column('log_metadata', sa.JSON(), nullable=True),
    sa.Column('ip_address', sa.String(length=100), nullable=True),
    sa.Column('user_agent', sa.String(length=500), nullable=True),
    sa.Column('request_method', sa.String(length=10), nullable=True),
    sa.Column('request_path', sa.String(length=500), nullable=True),
    sa.Column('success', sa.Boolean(), nullable=False),
    sa.Column('error_message', sa.Text(), nullable=True),
    sa.Column('severity', sa.String(length=50), nullable=False),
    sa.Column('compliance_tags', sa.JSON(), nullable=True),
    sa.Column('timestamp', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['ai_agent_id'], ['ai_agents.id'], name='fk_audit_ai_agent_id'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], name='fk_audit_enhanced_organization_id'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='fk_audit_enhanced_user_id'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_audit_actor', 'audit_logs_enhanced', ['actor_type', 'actor_id'], unique=False)
    op.create_index('idx_audit_ai_agent', 'audit_logs_enhanced', ['ai_agent_id'], unique=False)
    op.create_index('idx_audit_automation', 'audit_logs_enhanced', ['triggered_by_automation'], unique=False)
    op.create_index('idx_audit_org_action', 'audit_logs_enhanced', ['organization_id', 'action'], unique=False)
    op.create_index('idx_audit_org_entity', 'audit_logs_enhanced', ['organization_id', 'entity_type', 'entity_id'], unique=False)
    # op.create_index('idx_audit_org_timestamp', 'audit_logs_enhanced', ['organization_id', 'timestamp'], unique=False)
    op.create_index('idx_audit_user_timestamp', 'audit_logs_enhanced', ['user_id', 'timestamp'], unique=False)
    op.create_index(op.f('ix_audit_logs_enhanced_action'), 'audit_logs_enhanced', ['action'], unique=False)
    op.create_index(op.f('ix_audit_logs_enhanced_entity_id'), 'audit_logs_enhanced', ['entity_id'], unique=False)
    op.create_index(op.f('ix_audit_logs_enhanced_entity_type'), 'audit_logs_enhanced', ['entity_type'], unique=False)
    op.create_index(op.f('ix_audit_logs_enhanced_id'), 'audit_logs_enhanced', ['id'], unique=False)
    op.create_index(op.f('ix_audit_logs_enhanced_organization_id'), 'audit_logs_enhanced', ['organization_id'], unique=False)
    op.create_index(op.f('ix_audit_logs_enhanced_timestamp'), 'audit_logs_enhanced', ['timestamp'], unique=False)
    op.create_index(op.f('ix_audit_logs_enhanced_user_id'), 'audit_logs_enhanced', ['user_id'], unique=False)
    op.create_table('automl_runs',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('organization_id', sa.Integer(), nullable=False),
    sa.Column('run_name', sa.String(), nullable=False),
    sa.Column('task_type', sa.Enum('CLASSIFICATION', 'REGRESSION', 'TIME_SERIES', 'CLUSTERING', name='automltasktype'), nullable=False),
    sa.Column('framework', sa.Enum('AUTO_SKLEARN', 'TPOT', 'H2O', 'AUTOKERAS', 'OPTUNA', name='automlframework'), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('target_column', sa.String(), nullable=False),
    sa.Column('feature_columns', sa.JSON(), nullable=False),
    sa.Column('metric', sa.String(), nullable=False),
    sa.Column('time_budget', sa.Integer(), nullable=False),
    sa.Column('max_trials', sa.Integer(), nullable=False),
    sa.Column('dataset_path', sa.String(), nullable=True),
    sa.Column('dataset_config', sa.JSON(), nullable=True),
    sa.Column('train_test_split', sa.Float(), nullable=False),
    sa.Column('cross_validation_folds', sa.Integer(), nullable=False),
    sa.Column('status', sa.Enum('PENDING', 'RUNNING', 'COMPLETED', 'FAILED', 'CANCELLED', name='automlstatus'), nullable=False),
    sa.Column('progress', sa.Float(), nullable=False),
    sa.Column('current_trial', sa.Integer(), nullable=False),
    sa.Column('best_model_name', sa.String(), nullable=True),
    sa.Column('best_model_params', sa.JSON(), nullable=True),
    sa.Column('best_score', sa.Float(), nullable=True),
    sa.Column('best_model_path', sa.String(), nullable=True),
    sa.Column('trials_history', sa.JSON(), nullable=True),
    sa.Column('leaderboard', sa.JSON(), nullable=True),
    sa.Column('started_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('completed_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('error_message', sa.Text(), nullable=True),
    sa.Column('run_metadata', sa.JSON(), nullable=True),
    sa.Column('created_by_id', sa.Integer(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['created_by_id'], ['users.id'], name='fk_automl_run_created_by'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], name='fk_automl_run_org_id'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_automl_runs_id'), 'automl_runs', ['id'], unique=False)
    op.create_index(op.f('ix_automl_runs_organization_id'), 'automl_runs', ['organization_id'], unique=False)
    op.create_index(op.f('ix_automl_runs_run_name'), 'automl_runs', ['run_name'], unique=False)
    op.create_index(op.f('ix_automl_runs_status'), 'automl_runs', ['status'], unique=False)
    op.create_index(op.f('ix_automl_runs_task_type'), 'automl_runs', ['task_type'], unique=False)
    op.create_table('explainability_reports',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('organization_id', sa.Integer(), nullable=False),
    sa.Column('report_name', sa.String(), nullable=False),
    sa.Column('report_type', sa.String(), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('model_ids', sa.JSON(), nullable=False),
    sa.Column('summary', sa.JSON(), nullable=False),
    sa.Column('feature_analysis', sa.JSON(), nullable=True),
    sa.Column('model_comparisons', sa.JSON(), nullable=True),
    sa.Column('visualizations', sa.JSON(), nullable=True),
    sa.Column('key_insights', sa.JSON(), nullable=True),
    sa.Column('recommendations', sa.JSON(), nullable=True),
    sa.Column('generated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('report_format', sa.String(), nullable=False),
    sa.Column('report_path', sa.String(), nullable=True),
    sa.Column('created_by_id', sa.Integer(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['created_by_id'], ['users.id'], name='fk_explainability_report_created_by'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], name='fk_explainability_report_org_id'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_explainability_reports_id'), 'explainability_reports', ['id'], unique=False)
    op.create_index(op.f('ix_explainability_reports_organization_id'), 'explainability_reports', ['organization_id'], unique=False)
    op.create_index(op.f('ix_explainability_reports_report_name'), 'explainability_reports', ['report_name'], unique=False)
    op.create_table('external_data_sources',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('organization_id', sa.Integer(), nullable=False),
    sa.Column('source_name', sa.String(), nullable=False),
    sa.Column('source_type', sa.Enum('DATABASE', 'API', 'FILE_UPLOAD', 'CLOUD_STORAGE', 'STREAMING', name='datasourcetype'), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('connection_config', sa.JSON(), nullable=False),
    sa.Column('authentication_config', sa.JSON(), nullable=True),
    sa.Column('data_schema', sa.JSON(), nullable=True),
    sa.Column('field_mapping', sa.JSON(), nullable=True),
    sa.Column('sync_frequency', sa.String(), nullable=False),
    sa.Column('last_sync_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('next_sync_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('sync_status', sa.String(), nullable=False),
    sa.Column('last_error', sa.Text(), nullable=True),
    sa.Column('total_records_synced', sa.Integer(), nullable=False),
    sa.Column('last_sync_duration_seconds', sa.Float(), nullable=True),
    sa.Column('created_by_id', sa.Integer(), nullable=False),
    sa.Column('updated_by_id', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['created_by_id'], ['users.id'], name='fk_external_data_source_created_by'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], name='fk_external_data_source_org_id'),
    sa.ForeignKeyConstraint(['updated_by_id'], ['users.id'], name='fk_external_data_source_updated_by'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('organization_id', 'source_name', name='uq_external_data_source_org_name')
    )
    op.create_index('idx_external_data_source_active', 'external_data_sources', ['organization_id', 'is_active'], unique=False)
    op.create_index('idx_external_data_source_org_type', 'external_data_sources', ['organization_id', 'source_type'], unique=False)
    op.create_index(op.f('ix_external_data_sources_id'), 'external_data_sources', ['id'], unique=False)
    op.create_index(op.f('ix_external_data_sources_organization_id'), 'external_data_sources', ['organization_id'], unique=False)
    op.create_index(op.f('ix_external_data_sources_source_name'), 'external_data_sources', ['source_name'], unique=False)
    op.create_table('integrations',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('organization_id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=255), nullable=False),
    sa.Column('provider', sa.String(length=100), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('status', sa.String(length=50), nullable=False),
    sa.Column('enabled', sa.Boolean(), nullable=False),
    sa.Column('auth_type', sa.String(length=50), nullable=False),
    sa.Column('access_token', sa.Text(), nullable=True),
    sa.Column('refresh_token', sa.Text(), nullable=True),
    sa.Column('api_key', sa.String(length=500), nullable=True),
    sa.Column('api_secret', sa.String(length=500), nullable=True),
    sa.Column('webhook_url', sa.String(length=1000), nullable=True),
    sa.Column('webhook_secret', sa.String(length=500), nullable=True),
    sa.Column('token_expires_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('last_token_refresh', sa.DateTime(timezone=True), nullable=True),
    sa.Column('config', sa.JSON(), nullable=True),
    sa.Column('settings', sa.JSON(), nullable=True),
    sa.Column('workspace_id', sa.String(length=255), nullable=True),
    sa.Column('workspace_name', sa.String(length=255), nullable=True),
    sa.Column('channel_id', sa.String(length=255), nullable=True),
    sa.Column('phone_number', sa.String(length=50), nullable=True),
    sa.Column('total_messages_sent', sa.Integer(), nullable=False),
    sa.Column('total_messages_received', sa.Integer(), nullable=False),
    sa.Column('last_used_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('last_error', sa.Text(), nullable=True),
    sa.Column('last_error_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('error_count', sa.Integer(), nullable=False),
    sa.Column('created_by', sa.Integer(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('last_connected_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['created_by'], ['users.id'], name='fk_integration_creator_id'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], name='fk_integration_organization_id'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('organization_id', 'provider', 'name', name='uq_integration_org_provider_name')
    )
    # op.create_index('idx_integration_org_provider', 'integrations', ['organization_id', 'provider'], unique=False)
    # op.create_index('idx_integration_org_status', 'integrations', ['organization_id', 'status'], unique=False)
    op.create_index(op.f('ix_integrations_id'), 'integrations', ['id'], unique=False)
    op.create_index(op.f('ix_integrations_organization_id'), 'integrations', ['organization_id'], unique=False)
    op.create_index(op.f('ix_integrations_provider'), 'integrations', ['provider'], unique=False)
    op.create_index(op.f('ix_integrations_status'), 'integrations', ['status'], unique=False)
    op.create_table('ledger_entries',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('organization_id', sa.Integer(), nullable=False),
    sa.Column('date', sa.Date(), nullable=False),
    sa.Column('voucher_type', sa.String(), nullable=False),
    sa.Column('voucher_number', sa.String(), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('debit_amount', sa.Numeric(precision=15, scale=2), nullable=False),
    sa.Column('credit_amount', sa.Numeric(precision=15, scale=2), nullable=False),
    sa.Column('balance', sa.Numeric(precision=15, scale=2), nullable=False),
    sa.Column('account_type', sa.String(), nullable=False),
    sa.Column('account_id', sa.Integer(), nullable=False),
    sa.Column('account_name', sa.String(), nullable=False),
    sa.Column('source_document_type', sa.String(), nullable=True),
    sa.Column('source_document_id', sa.Integer(), nullable=True),
    sa.Column('status', sa.String(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('created_by', sa.Integer(), nullable=True),
    sa.ForeignKeyConstraint(['created_by'], ['users.id'], ),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('organization_id', 'voucher_type', 'voucher_number', name='uq_ledger_org_voucher')
    )
    op.create_index('idx_ledger_org_account', 'ledger_entries', ['organization_id', 'account_type', 'account_id'], unique=False)
    op.create_index('idx_ledger_org_date', 'ledger_entries', ['organization_id', 'date'], unique=False)
    op.create_index(op.f('ix_ledger_entries_account_id'), 'ledger_entries', ['account_id'], unique=False)
    op.create_index(op.f('ix_ledger_entries_date'), 'ledger_entries', ['date'], unique=False)
    op.create_index(op.f('ix_ledger_entries_id'), 'ledger_entries', ['id'], unique=False)
    op.create_index(op.f('ix_ledger_entries_organization_id'), 'ledger_entries', ['organization_id'], unique=False)
    op.create_index(op.f('ix_ledger_entries_voucher_number'), 'ledger_entries', ['voucher_number'], unique=False)
    op.create_index(op.f('ix_ledger_entries_voucher_type'), 'ledger_entries', ['voucher_type'], unique=False)
    op.create_table('ml_algorithm_configs',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('organization_id', sa.Integer(), nullable=False),
    sa.Column('config_name', sa.String(), nullable=False),
    sa.Column('framework', sa.Enum('SCIKIT_LEARN', 'CATBOOST', 'LIGHTGBM', 'TENSORFLOW', 'PYTORCH', 'XGBOOST', name='mlframework'), nullable=False),
    sa.Column('algorithm_name', sa.String(), nullable=False),
    sa.Column('category', sa.Enum('CLASSIFICATION', 'REGRESSION', 'CLUSTERING', 'DIMENSIONALITY_REDUCTION', 'ENSEMBLE', 'DEEP_LEARNING', 'TIME_SERIES', name='algorithmcategory'), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('hyperparameters', sa.JSON(), nullable=False),
    sa.Column('preprocessing_config', sa.JSON(), nullable=True),
    sa.Column('framework_version', sa.String(), nullable=True),
    sa.Column('gpu_enabled', sa.Boolean(), nullable=False),
    sa.Column('device_config', sa.JSON(), nullable=True),
    sa.Column('is_default', sa.Boolean(), nullable=False),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('tags', sa.JSON(), nullable=True),
    sa.Column('created_by_id', sa.Integer(), nullable=False),
    sa.Column('updated_by_id', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['created_by_id'], ['users.id'], name='fk_ml_algorithm_config_created_by'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], name='fk_ml_algorithm_config_org_id'),
    sa.ForeignKeyConstraint(['updated_by_id'], ['users.id'], name='fk_ml_algorithm_config_updated_by'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_ml_algorithm_configs_category'), 'ml_algorithm_configs', ['category'], unique=False)
    op.create_index(op.f('ix_ml_algorithm_configs_config_name'), 'ml_algorithm_configs', ['config_name'], unique=False)
    op.create_index(op.f('ix_ml_algorithm_configs_framework'), 'ml_algorithm_configs', ['framework'], unique=False)
    op.create_index(op.f('ix_ml_algorithm_configs_id'), 'ml_algorithm_configs', ['id'], unique=False)
    op.create_index(op.f('ix_ml_algorithm_configs_organization_id'), 'ml_algorithm_configs', ['organization_id'], unique=False)
    op.create_table('model_explainability',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('organization_id', sa.Integer(), nullable=False),
    sa.Column('model_id', sa.Integer(), nullable=False),
    sa.Column('model_type', sa.String(), nullable=False),
    sa.Column('model_name', sa.String(), nullable=False),
    sa.Column('method', sa.Enum('SHAP', 'LIME', 'FEATURE_IMPORTANCE', 'PARTIAL_DEPENDENCE', 'ICE_PLOT', name='explainabilitymethod'), nullable=False),
    sa.Column('scope', sa.Enum('GLOBAL', 'LOCAL', 'COHORT', name='explainabilityscope'), nullable=False),
    sa.Column('config', sa.JSON(), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('feature_importance', sa.JSON(), nullable=True),
    sa.Column('shap_values', sa.JSON(), nullable=True),
    sa.Column('lime_explanation', sa.JSON(), nullable=True),
    sa.Column('visualization_data', sa.JSON(), nullable=True),
    sa.Column('top_features', sa.JSON(), nullable=True),
    sa.Column('feature_correlations', sa.JSON(), nullable=True),
    sa.Column('is_cached', sa.Boolean(), nullable=False),
    sa.Column('cache_expires_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('computation_time', sa.Float(), nullable=True),
    sa.Column('created_by_id', sa.Integer(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['created_by_id'], ['users.id'], name='fk_model_explainability_created_by'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], name='fk_model_explainability_org_id'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_model_explainability_id'), 'model_explainability', ['id'], unique=False)
    op.create_index(op.f('ix_model_explainability_method'), 'model_explainability', ['method'], unique=False)
    op.create_index(op.f('ix_model_explainability_model_id'), 'model_explainability', ['model_id'], unique=False)
    op.create_index(op.f('ix_model_explainability_model_name'), 'model_explainability', ['model_name'], unique=False)
    op.create_index(op.f('ix_model_explainability_organization_id'), 'model_explainability', ['organization_id'], unique=False)
    op.create_index(op.f('ix_model_explainability_scope'), 'model_explainability', ['scope'], unique=False)
    op.create_table('plugin_hooks',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('plugin_id', sa.Integer(), nullable=False),
    sa.Column('hook_name', sa.String(length=255), nullable=False),
    sa.Column('event_type', sa.String(length=100), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('handler_function', sa.String(length=500), nullable=False),
    sa.Column('priority', sa.Integer(), nullable=False),
    sa.Column('enabled', sa.Boolean(), nullable=False),
    sa.Column('execution_count', sa.Integer(), nullable=False),
    sa.Column('last_executed_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('average_execution_time_ms', sa.JSON(), nullable=True),
    sa.Column('error_count', sa.Integer(), nullable=False),
    sa.Column('last_error', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['plugin_id'], ['plugins.id'], name='fk_hook_plugin_id'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_hook_name', 'plugin_hooks', ['hook_name'], unique=False)
    op.create_index('idx_hook_plugin_event', 'plugin_hooks', ['plugin_id', 'event_type'], unique=False)
    op.create_index(op.f('ix_plugin_hooks_hook_name'), 'plugin_hooks', ['hook_name'], unique=False)
    op.create_index(op.f('ix_plugin_hooks_id'), 'plugin_hooks', ['id'], unique=False)
    op.create_index(op.f('ix_plugin_hooks_plugin_id'), 'plugin_hooks', ['plugin_id'], unique=False)
    op.create_table('plugin_installations',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('plugin_id', sa.Integer(), nullable=False),
    sa.Column('organization_id', sa.Integer(), nullable=False),
    sa.Column('installed_by', sa.Integer(), nullable=True),
    sa.Column('installed_version', sa.String(length=50), nullable=False),
    sa.Column('active', sa.Boolean(), nullable=False),
    sa.Column('settings', sa.JSON(), nullable=True),
    sa.Column('last_used_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('usage_count', sa.Integer(), nullable=False),
    sa.Column('error_count', sa.Integer(), nullable=False),
    sa.Column('last_error', sa.Text(), nullable=True),
    sa.Column('last_error_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('installed_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['installed_by'], ['users.id'], name='fk_installation_user_id'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], name='fk_installation_organization_id'),
    sa.ForeignKeyConstraint(['plugin_id'], ['plugins.id'], name='fk_installation_plugin_id'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('plugin_id', 'organization_id', name='uq_plugin_org_installation')
    )
    op.create_index('idx_installation_org_plugin', 'plugin_installations', ['organization_id', 'plugin_id'], unique=False)
    op.create_index(op.f('ix_plugin_installations_id'), 'plugin_installations', ['id'], unique=False)
    op.create_index(op.f('ix_plugin_installations_organization_id'), 'plugin_installations', ['organization_id'], unique=False)
    op.create_index(op.f('ix_plugin_installations_plugin_id'), 'plugin_installations', ['plugin_id'], unique=False)
    op.create_table('predictive_models',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('organization_id', sa.Integer(), nullable=False),
    sa.Column('model_name', sa.String(), nullable=False),
    sa.Column('model_type', sa.Enum('SALES_FORECAST', 'DEMAND_PREDICTION', 'CHURN_PREDICTION', 'REVENUE_FORECAST', 'INVENTORY_OPTIMIZATION', 'CUSTOMER_LIFETIME_VALUE', 'PRICE_OPTIMIZATION', 'LEAD_SCORING', name='predictivemodeltype'), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('version', sa.String(), nullable=False),
    sa.Column('algorithm', sa.String(), nullable=False),
    sa.Column('hyperparameters', sa.JSON(), nullable=True),
    sa.Column('feature_engineering', sa.JSON(), nullable=True),
    sa.Column('training_config', sa.JSON(), nullable=False),
    sa.Column('validation_split', sa.Float(), nullable=False),
    sa.Column('test_split', sa.Float(), nullable=False),
    sa.Column('accuracy_score', sa.Float(), nullable=True),
    sa.Column('precision_score', sa.Float(), nullable=True),
    sa.Column('recall_score', sa.Float(), nullable=True),
    sa.Column('f1_score', sa.Float(), nullable=True),
    sa.Column('mae', sa.Float(), nullable=True),
    sa.Column('rmse', sa.Float(), nullable=True),
    sa.Column('r2_score', sa.Float(), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('deployed_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('prediction_count', sa.Integer(), nullable=False),
    sa.Column('last_prediction_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('model_path', sa.String(), nullable=True),
    sa.Column('model_metadata', sa.JSON(), nullable=True),
    sa.Column('created_by_id', sa.Integer(), nullable=False),
    sa.Column('updated_by_id', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['created_by_id'], ['users.id'], name='fk_predictive_model_created_by'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], name='fk_predictive_model_org_id'),
    sa.ForeignKeyConstraint(['updated_by_id'], ['users.id'], name='fk_predictive_model_updated_by'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('organization_id', 'model_name', 'version', name='uq_predictive_model_org_name_version')
    )
    op.create_index('idx_predictive_model_active', 'predictive_models', ['organization_id', 'is_active'], unique=False)
    op.create_index('idx_predictive_model_org_type', 'predictive_models', ['organization_id', 'model_type'], unique=False)
    op.create_index(op.f('ix_predictive_models_id'), 'predictive_models', ['id'], unique=False)
    op.create_index(op.f('ix_predictive_models_model_name'), 'predictive_models', ['model_name'], unique=False)
    op.create_index(op.f('ix_predictive_models_model_type'), 'predictive_models', ['model_type'], unique=False)
    op.create_index(op.f('ix_predictive_models_organization_id'), 'predictive_models', ['organization_id'], unique=False)
    op.create_table('streaming_data_sources',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('organization_id', sa.Integer(), nullable=False),
    sa.Column('source_name', sa.String(length=255), nullable=False),
    sa.Column('source_type', sa.String(length=50), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('connection_config', sa.JSON(), nullable=False),
    sa.Column('status', sa.Enum('ACTIVE', 'PAUSED', 'ERROR', 'STOPPED', name='streamstatus'), nullable=False),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('last_message_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('message_count', sa.Integer(), nullable=False),
    sa.Column('error_count', sa.Integer(), nullable=False),
    sa.Column('created_by_id', sa.Integer(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['created_by_id'], ['users.id'], name='fk_stream_source_created_by'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], name='fk_stream_source_org_id'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_stream_source_org_status', 'streaming_data_sources', ['organization_id', 'status'], unique=False)
    op.create_index(op.f('ix_streaming_data_sources_id'), 'streaming_data_sources', ['id'], unique=False)
    op.create_index(op.f('ix_streaming_data_sources_organization_id'), 'streaming_data_sources', ['organization_id'], unique=False)
    op.create_index(op.f('ix_streaming_data_sources_status'), 'streaming_data_sources', ['status'], unique=False)
    op.create_table('ab_test_variants',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('experiment_id', sa.Integer(), nullable=False),
    sa.Column('variant_name', sa.String(length=100), nullable=False),
    sa.Column('variant_type', sa.Enum('CONTROL', 'TREATMENT', name='varianttype'), nullable=False),
    sa.Column('model_id', sa.Integer(), nullable=True),
    sa.Column('model_version', sa.String(length=50), nullable=True),
    sa.Column('variant_config', sa.JSON(), nullable=True),
    sa.Column('traffic_percentage', sa.Float(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['experiment_id'], ['ab_test_experiments.id'], name='fk_variant_experiment_id'),
    sa.ForeignKeyConstraint(['model_id'], ['ai_models.id'], name='fk_variant_model_id'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_variant_experiment', 'ab_test_variants', ['experiment_id'], unique=False)
    op.create_index(op.f('ix_ab_test_variants_experiment_id'), 'ab_test_variants', ['experiment_id'], unique=False)
    op.create_index(op.f('ix_ab_test_variants_id'), 'ab_test_variants', ['id'], unique=False)
    op.create_table('anomaly_detection_results',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('organization_id', sa.Integer(), nullable=False),
    sa.Column('anomaly_model_id', sa.Integer(), nullable=False),
    sa.Column('detected_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('severity', sa.String(), nullable=False),
    sa.Column('anomaly_score', sa.Float(), nullable=False),
    sa.Column('affected_data', sa.JSON(), nullable=False),
    sa.Column('expected_range', sa.JSON(), nullable=True),
    sa.Column('actual_value', sa.JSON(), nullable=True),
    sa.Column('context', sa.JSON(), nullable=True),
    sa.Column('root_cause_analysis', sa.Text(), nullable=True),
    sa.Column('is_resolved', sa.Boolean(), nullable=False),
    sa.Column('resolved_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('resolved_by_id', sa.Integer(), nullable=True),
    sa.Column('resolution_notes', sa.Text(), nullable=True),
    sa.Column('is_false_positive', sa.Boolean(), nullable=False),
    sa.Column('false_positive_reason', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['anomaly_model_id'], ['anomaly_detection_models.id'], name='fk_anomaly_result_model_id'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], name='fk_anomaly_result_org_id'),
    sa.ForeignKeyConstraint(['resolved_by_id'], ['users.id'], name='fk_anomaly_result_resolved_by'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_anomaly_result_org_detected', 'anomaly_detection_results', ['organization_id', 'detected_at'], unique=False)
    op.create_index('idx_anomaly_result_resolved', 'anomaly_detection_results', ['organization_id', 'is_resolved'], unique=False)
    op.create_index('idx_anomaly_result_severity', 'anomaly_detection_results', ['organization_id', 'severity'], unique=False)
    op.create_index(op.f('ix_anomaly_detection_results_anomaly_model_id'), 'anomaly_detection_results', ['anomaly_model_id'], unique=False)
    op.create_index(op.f('ix_anomaly_detection_results_detected_at'), 'anomaly_detection_results', ['detected_at'], unique=False)
    op.create_index(op.f('ix_anomaly_detection_results_id'), 'anomaly_detection_results', ['id'], unique=False)
    op.create_index(op.f('ix_anomaly_detection_results_organization_id'), 'anomaly_detection_results', ['organization_id'], unique=False)
    op.create_table('automl_model_candidates',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('automl_run_id', sa.Integer(), nullable=False),
    sa.Column('organization_id', sa.Integer(), nullable=False),
    sa.Column('trial_number', sa.Integer(), nullable=False),
    sa.Column('model_name', sa.String(), nullable=False),
    sa.Column('algorithm', sa.String(), nullable=False),
    sa.Column('hyperparameters', sa.JSON(), nullable=False),
    sa.Column('score', sa.Float(), nullable=False),
    sa.Column('training_time', sa.Float(), nullable=False),
    sa.Column('evaluation_metrics', sa.JSON(), nullable=True),
    sa.Column('model_path', sa.String(), nullable=True),
    sa.Column('feature_importance', sa.JSON(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['automl_run_id'], ['automl_runs.id'], name='fk_model_candidate_run_id'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], name='fk_model_candidate_org_id'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_automl_model_candidates_automl_run_id'), 'automl_model_candidates', ['automl_run_id'], unique=False)
    op.create_index(op.f('ix_automl_model_candidates_id'), 'automl_model_candidates', ['id'], unique=False)
    op.create_index(op.f('ix_automl_model_candidates_organization_id'), 'automl_model_candidates', ['organization_id'], unique=False)
    op.create_table('ml_model_trainings',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('organization_id', sa.Integer(), nullable=False),
    sa.Column('training_name', sa.String(), nullable=False),
    sa.Column('framework', sa.Enum('SCIKIT_LEARN', 'CATBOOST', 'LIGHTGBM', 'TENSORFLOW', 'PYTORCH', 'XGBOOST', name='mlframework'), nullable=False),
    sa.Column('task_type', sa.Enum('CLASSIFICATION', 'REGRESSION', 'CLUSTERING', 'DIMENSIONALITY_REDUCTION', 'ENSEMBLE', 'DEEP_LEARNING', 'TIME_SERIES', name='mltasktype'), nullable=False),
    sa.Column('algorithm_config_id', sa.Integer(), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('target_column', sa.String(), nullable=False),
    sa.Column('feature_columns', sa.JSON(), nullable=False),
    sa.Column('training_config', sa.JSON(), nullable=False),
    sa.Column('status', sa.Enum('PENDING', 'RUNNING', 'COMPLETED', 'FAILED', 'CANCELLED', name='trainingstatus'), nullable=False),
    sa.Column('progress', sa.Float(), nullable=False),
    sa.Column('started_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('completed_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('error_message', sa.Text(), nullable=True),
    sa.Column('model_path', sa.String(), nullable=True),
    sa.Column('metrics', sa.JSON(), nullable=True),
    sa.Column('created_by_id', sa.Integer(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['algorithm_config_id'], ['ml_algorithm_configs.id'], name='fk_ml_training_config_id'),
    sa.ForeignKeyConstraint(['created_by_id'], ['users.id'], name='fk_ml_training_created_by'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], name='fk_ml_training_org_id'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_ml_model_trainings_algorithm_config_id'), 'ml_model_trainings', ['algorithm_config_id'], unique=False)
    op.create_index(op.f('ix_ml_model_trainings_framework'), 'ml_model_trainings', ['framework'], unique=False)
    op.create_index(op.f('ix_ml_model_trainings_id'), 'ml_model_trainings', ['id'], unique=False)
    op.create_index(op.f('ix_ml_model_trainings_organization_id'), 'ml_model_trainings', ['organization_id'], unique=False)
    op.create_index(op.f('ix_ml_model_trainings_status'), 'ml_model_trainings', ['status'], unique=False)
    op.create_index(op.f('ix_ml_model_trainings_training_name'), 'ml_model_trainings', ['training_name'], unique=False)
    op.create_table('prediction_explanations',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('organization_id', sa.Integer(), nullable=False),
    sa.Column('model_explainability_id', sa.Integer(), nullable=False),
    sa.Column('prediction_id', sa.String(), nullable=True),
    sa.Column('input_features', sa.JSON(), nullable=False),
    sa.Column('predicted_value', sa.Float(), nullable=False),
    sa.Column('confidence_score', sa.Float(), nullable=True),
    sa.Column('method', sa.Enum('SHAP', 'LIME', 'FEATURE_IMPORTANCE', 'PARTIAL_DEPENDENCE', 'ICE_PLOT', name='explainabilitymethod'), nullable=False),
    sa.Column('shap_values', sa.JSON(), nullable=True),
    sa.Column('lime_explanation', sa.JSON(), nullable=True),
    sa.Column('feature_contributions', sa.JSON(), nullable=True),
    sa.Column('top_positive_features', sa.JSON(), nullable=True),
    sa.Column('top_negative_features', sa.JSON(), nullable=True),
    sa.Column('visualization_data', sa.JSON(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['model_explainability_id'], ['model_explainability.id'], name='fk_prediction_explanation_explainability_id'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], name='fk_prediction_explanation_org_id'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_prediction_explanations_id'), 'prediction_explanations', ['id'], unique=False)
    op.create_index(op.f('ix_prediction_explanations_model_explainability_id'), 'prediction_explanations', ['model_explainability_id'], unique=False)
    op.create_index(op.f('ix_prediction_explanations_organization_id'), 'prediction_explanations', ['organization_id'], unique=False)
    op.create_index(op.f('ix_prediction_explanations_prediction_id'), 'prediction_explanations', ['prediction_id'], unique=False)
    op.create_table('prediction_history',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('organization_id', sa.Integer(), nullable=False),
    sa.Column('model_id', sa.Integer(), nullable=False),
    sa.Column('prediction_timestamp', sa.DateTime(timezone=True), nullable=False),
    sa.Column('input_data', sa.JSON(), nullable=False),
    sa.Column('predicted_value', sa.JSON(), nullable=False),
    sa.Column('confidence_score', sa.Float(), nullable=True),
    sa.Column('actual_value', sa.JSON(), nullable=True),
    sa.Column('prediction_error', sa.Float(), nullable=True),
    sa.Column('user_id', sa.Integer(), nullable=True),
    sa.Column('context_metadata', sa.JSON(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['model_id'], ['predictive_models.id'], name='fk_prediction_history_model_id'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], name='fk_prediction_history_org_id'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='fk_prediction_history_user_id'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_prediction_history_model_timestamp', 'prediction_history', ['model_id', 'prediction_timestamp'], unique=False)
    op.create_index('idx_prediction_history_org_timestamp', 'prediction_history', ['organization_id', 'prediction_timestamp'], unique=False)
    op.create_index(op.f('ix_prediction_history_id'), 'prediction_history', ['id'], unique=False)
    op.create_index(op.f('ix_prediction_history_model_id'), 'prediction_history', ['model_id'], unique=False)
    op.create_index(op.f('ix_prediction_history_organization_id'), 'prediction_history', ['organization_id'], unique=False)
    op.create_index(op.f('ix_prediction_history_prediction_timestamp'), 'prediction_history', ['prediction_timestamp'], unique=False)
    op.create_table('streaming_alerts',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('organization_id', sa.Integer(), nullable=False),
    sa.Column('data_source_id', sa.Integer(), nullable=True),
    sa.Column('alert_type', sa.String(length=100), nullable=False),
    sa.Column('alert_title', sa.String(length=255), nullable=False),
    sa.Column('alert_message', sa.Text(), nullable=False),
    sa.Column('severity', sa.Enum('INFO', 'WARNING', 'ERROR', 'CRITICAL', name='alertseverity'), nullable=False),
    sa.Column('status', postgresql.ENUM('OPEN', 'ACKNOWLEDGED', 'RESOLVED', 'CLOSED', name='alertstatus', create_type=False), nullable=False),
    sa.Column('alert_data', sa.JSON(), nullable=True),
    sa.Column('acknowledged_by_id', sa.Integer(), nullable=True),
    sa.Column('acknowledged_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('resolved_by_id', sa.Integer(), nullable=True),
    sa.Column('resolved_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('resolution_notes', sa.Text(), nullable=True),
    sa.Column('triggered_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['acknowledged_by_id'], ['users.id'], name='fk_alert_acknowledged_by'),
    sa.ForeignKeyConstraint(['data_source_id'], ['streaming_data_sources.id'], name='fk_alert_data_source_id'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], name='fk_stream_alert_org_id'),
    sa.ForeignKeyConstraint(['resolved_by_id'], ['users.id'], name='fk_alert_resolved_by'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_alert_org_status', 'streaming_alerts', ['organization_id', 'status'], unique=False)
    op.create_index('idx_alert_severity', 'streaming_alerts', ['severity', 'status'], unique=False)
    op.create_index('idx_alert_triggered', 'streaming_alerts', ['triggered_at'], unique=False)
    op.create_index(op.f('ix_streaming_alerts_alert_type'), 'streaming_alerts', ['alert_type'], unique=False)
    op.create_index(op.f('ix_streaming_alerts_id'), 'streaming_alerts', ['id'], unique=False)
    op.create_index(op.f('ix_streaming_alerts_organization_id'), 'streaming_alerts', ['organization_id'], unique=False)
    op.create_index(op.f('ix_streaming_alerts_severity'), 'streaming_alerts', ['severity'], unique=False)
    op.create_index(op.f('ix_streaming_alerts_status'), 'streaming_alerts', ['status'], unique=False)
    op.create_index(op.f('ix_streaming_alerts_triggered_at'), 'streaming_alerts', ['triggered_at'], unique=False)
    op.create_table('streaming_events',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('data_source_id', sa.Integer(), nullable=False),
    sa.Column('organization_id', sa.Integer(), nullable=False),
    sa.Column('event_type', sa.String(length=100), nullable=False),
    sa.Column('event_data', sa.JSON(), nullable=False),
    sa.Column('processed', sa.Boolean(), nullable=False),
    sa.Column('processed_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('event_timestamp', sa.DateTime(timezone=True), nullable=False),
    sa.Column('received_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['data_source_id'], ['streaming_data_sources.id'], name='fk_event_data_source_id'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], name='fk_stream_event_org_id'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_event_processed', 'streaming_events', ['processed', 'event_timestamp'], unique=False)
    op.create_index('idx_event_source_type', 'streaming_events', ['data_source_id', 'event_type'], unique=False)
    op.create_index('idx_event_timestamp', 'streaming_events', ['event_timestamp'], unique=False)
    op.create_index(op.f('ix_streaming_events_data_source_id'), 'streaming_events', ['data_source_id'], unique=False)
    op.create_index(op.f('ix_streaming_events_event_timestamp'), 'streaming_events', ['event_timestamp'], unique=False)
    op.create_index(op.f('ix_streaming_events_event_type'), 'streaming_events', ['event_type'], unique=False)
    op.create_index(op.f('ix_streaming_events_id'), 'streaming_events', ['id'], unique=False)
    op.create_index(op.f('ix_streaming_events_organization_id'), 'streaming_events', ['organization_id'], unique=False)
    op.create_index(op.f('ix_streaming_events_processed'), 'streaming_events', ['processed'], unique=False)
    op.create_table('streaming_metrics',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('organization_id', sa.Integer(), nullable=False),
    sa.Column('data_source_id', sa.Integer(), nullable=True),
    sa.Column('metric_name', sa.String(length=100), nullable=False),
    sa.Column('metric_value', sa.Float(), nullable=False),
    sa.Column('aggregation_type', sa.String(length=50), nullable=False),
    sa.Column('time_window', sa.String(length=50), nullable=False),
    sa.Column('window_start', sa.DateTime(timezone=True), nullable=False),
    sa.Column('window_end', sa.DateTime(timezone=True), nullable=False),
    sa.Column('dimensions', sa.JSON(), nullable=True),
    sa.Column('calculated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['data_source_id'], ['streaming_data_sources.id'], name='fk_metric_data_source_id'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], name='fk_stream_metric_org_id'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_metric_name_window', 'streaming_metrics', ['metric_name', 'window_start'], unique=False)
    op.create_index('idx_metric_org_name', 'streaming_metrics', ['organization_id', 'metric_name'], unique=False)
    op.create_index('idx_metric_window', 'streaming_metrics', ['window_start', 'window_end'], unique=False)
    op.create_index(op.f('ix_streaming_metrics_id'), 'streaming_metrics', ['id'], unique=False)
    op.create_index(op.f('ix_streaming_metrics_metric_name'), 'streaming_metrics', ['metric_name'], unique=False)
    op.create_index(op.f('ix_streaming_metrics_organization_id'), 'streaming_metrics', ['organization_id'], unique=False)
    op.create_index(op.f('ix_streaming_metrics_window_start'), 'streaming_metrics', ['window_start'], unique=False)
    op.create_table('ab_test_assignments',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('experiment_id', sa.Integer(), nullable=False),
    sa.Column('variant_id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=True),
    sa.Column('session_id', sa.String(length=255), nullable=True),
    sa.Column('assigned_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('last_seen_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['experiment_id'], ['ab_test_experiments.id'], name='fk_assignment_experiment_id'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='fk_assignment_user_id'),
    sa.ForeignKeyConstraint(['variant_id'], ['ab_test_variants.id'], name='fk_assignment_variant_id'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_assignment_experiment_session', 'ab_test_assignments', ['experiment_id', 'session_id'], unique=False)
    op.create_index('idx_assignment_experiment_user', 'ab_test_assignments', ['experiment_id', 'user_id'], unique=False)
    op.create_index(op.f('ix_ab_test_assignments_experiment_id'), 'ab_test_assignments', ['experiment_id'], unique=False)
    op.create_index(op.f('ix_ab_test_assignments_id'), 'ab_test_assignments', ['id'], unique=False)
    op.create_index(op.f('ix_ab_test_assignments_session_id'), 'ab_test_assignments', ['session_id'], unique=False)
    op.create_index(op.f('ix_ab_test_assignments_user_id'), 'ab_test_assignments', ['user_id'], unique=False)
    op.create_table('ab_test_results',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('experiment_id', sa.Integer(), nullable=False),
    sa.Column('variant_id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=True),
    sa.Column('session_id', sa.String(length=255), nullable=True),
    sa.Column('metric_name', sa.String(length=100), nullable=False),
    sa.Column('metric_value', sa.Float(), nullable=False),
    sa.Column('result_metadata', sa.JSON(), nullable=True),
    sa.Column('recorded_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['experiment_id'], ['ab_test_experiments.id'], name='fk_result_experiment_id'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='fk_result_user_id'),
    sa.ForeignKeyConstraint(['variant_id'], ['ab_test_variants.id'], name='fk_result_variant_id'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_result_experiment_variant', 'ab_test_results', ['experiment_id', 'variant_id'], unique=False)
    op.create_index('idx_result_recorded_at', 'ab_test_results', ['recorded_at'], unique=False)
    op.create_index(op.f('ix_ab_test_results_experiment_id'), 'ab_test_results', ['experiment_id'], unique=False)
    op.create_index(op.f('ix_ab_test_results_id'), 'ab_test_results', ['id'], unique=False)
    op.create_index(op.f('ix_ab_test_results_recorded_at'), 'ab_test_results', ['recorded_at'], unique=False)
    op.create_index(op.f('ix_ab_test_results_session_id'), 'ab_test_results', ['session_id'], unique=False)
    op.create_index(op.f('ix_ab_test_results_variant_id'), 'ab_test_results', ['variant_id'], unique=False)
    op.create_table('integration_webhooks',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('organization_id', sa.Integer(), nullable=False),
    sa.Column('integration_id', sa.Integer(), nullable=False),
    sa.Column('url', sa.String(length=1000), nullable=False),
    sa.Column('event_types', sa.JSON(), nullable=True),
    sa.Column('secret', sa.String(length=500), nullable=True),
    sa.Column('active', sa.Boolean(), nullable=False),
    sa.Column('last_triggered_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['integration_id'], ['integrations.id'], name='fk_webhook_integration_id'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], name='fk_webhook_organization_id'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_webhook_org_integration', 'integration_webhooks', ['organization_id', 'integration_id'], unique=False)
    op.create_index('idx_webhook_active', 'integration_webhooks', ['active'], unique=False)
    op.create_index(op.f('ix_integration_webhooks_id'), 'integration_webhooks', ['id'], unique=False)
    op.create_index(op.f('ix_integration_webhooks_integration_id'), 'integration_webhooks', ['integration_id'], unique=False)
    op.create_index(op.f('ix_integration_webhooks_organization_id'), 'integration_webhooks', ['organization_id'], unique=False)
    op.create_table('integration_webhook_events',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('organization_id', sa.Integer(), nullable=False),
    sa.Column('webhook_id', sa.Integer(), nullable=False),
    sa.Column('event_type', sa.String(length=100), nullable=False),
    sa.Column('event_id', sa.String(length=255), nullable=True),
    sa.Column('payload', sa.JSON(), nullable=True),
    sa.Column('headers', sa.JSON(), nullable=True),
    sa.Column('processed', sa.Boolean(), nullable=False),
    sa.Column('processed_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('error_message', sa.Text(), nullable=True),
    sa.Column('retry_count', sa.Integer(), nullable=False),
    sa.Column('received_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], name='fk_webhook_event_organization_id'),
    sa.ForeignKeyConstraint(['webhook_id'], ['integration_webhooks.id'], name='fk_event_webhook_id'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_webhook_event_org_webhook', 'integration_webhook_events', ['organization_id', 'webhook_id'], unique=False)
    op.create_index('idx_webhook_event_processed', 'integration_webhook_events', ['processed'], unique=False)
    op.create_index('idx_webhook_event_type', 'integration_webhook_events', ['event_type'], unique=False)
    op.create_index(op.f('ix_integration_webhook_events_event_id'), 'integration_webhook_events', ['event_id'], unique=False)
    op.create_index(op.f('ix_integration_webhook_events_event_type'), 'integration_webhook_events', ['event_type'], unique=False)
    op.create_index(op.f('ix_integration_webhook_events_id'), 'integration_webhook_events', ['id'], unique=False)
    op.create_index(op.f('ix_integration_webhook_events_organization_id'), 'integration_webhook_events', ['organization_id'], unique=False)
    op.create_index(op.f('ix_integration_webhook_events_received_at'), 'integration_webhook_events', ['received_at'], unique=False)
    op.create_index(op.f('ix_integration_webhook_events_webhook_id'), 'integration_webhook_events', ['webhook_id'], unique=False)
    op.create_table('orders',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('organization_id', sa.Integer(), nullable=False),
    sa.Column('order_number', sa.String(), nullable=False),
    sa.Column('customer_id', sa.Integer(), nullable=False),
    sa.Column('sales_order_id', sa.Integer(), nullable=True),
    sa.Column('order_date', sa.Date(), nullable=False),
    sa.Column('due_date', sa.Date(), nullable=False),
    sa.Column('status', sa.String(), nullable=False),
    sa.Column('workflow_stage', sa.String(), nullable=False),
    sa.Column('total_amount', sa.Float(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_by_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['created_by_id'], ['users.id'], ),
    sa.ForeignKeyConstraint(['customer_id'], ['customers.id'], ),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], ),
    sa.ForeignKeyConstraint(['sales_order_id'], ['sales_orders.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('organization_id', 'order_number', name='uq_order_org_number')
    )
    op.create_index('idx_order_org_customer', 'orders', ['organization_id', 'customer_id'], unique=False)
    op.create_index('idx_order_org_date', 'orders', ['organization_id', 'order_date'], unique=False)
    op.create_index('idx_order_org_stage', 'orders', ['organization_id', 'workflow_stage'], unique=False)
    op.create_index('idx_order_org_status', 'orders', ['organization_id', 'status'], unique=False)
    op.create_index(op.f('ix_orders_id'), 'orders', ['id'], unique=False)
    op.create_index(op.f('ix_orders_order_number'), 'orders', ['order_number'], unique=True)
    op.create_index(op.f('ix_orders_organization_id'), 'orders', ['organization_id'], unique=False)
    op.create_table('order_items',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('order_id', sa.Integer(), nullable=False),
    sa.Column('product_id', sa.Integer(), nullable=False),
    sa.Column('quantity', sa.Float(), nullable=False),
    sa.Column('unit_price', sa.Float(), nullable=False),
    sa.Column('amount', sa.Float(), nullable=False),
    sa.ForeignKeyConstraint(['order_id'], ['orders.id'], ),
    sa.ForeignKeyConstraint(['product_id'], ['products.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_order_item_order', 'order_items', ['order_id'], unique=False)
    op.create_index('idx_order_item_product', 'order_items', ['product_id'], unique=False)
    op.create_index(op.f('ix_order_items_id'), 'order_items', ['id'], unique=False)
    op.create_table('order_workflow_history',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('order_id', sa.Integer(), nullable=False),
    sa.Column('from_stage', sa.String(), nullable=True),
    sa.Column('to_stage', sa.String(), nullable=False),
    sa.Column('changed_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('changed_by_id', sa.Integer(), nullable=False),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.ForeignKeyConstraint(['changed_by_id'], ['users.id'], ),
    sa.ForeignKeyConstraint(['order_id'], ['orders.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_workflow_history_changed_at', 'order_workflow_history', ['changed_at'], unique=False)
    op.create_index('idx_workflow_history_order', 'order_workflow_history', ['order_id'], unique=False)
    op.create_index(op.f('ix_order_workflow_history_id'), 'order_workflow_history', ['id'], unique=False)
    op.drop_table('schema_version')
    op.drop_index('idx_inventory_alert_created_at', table_name='inventory_alerts')
    op.drop_index('idx_inventory_alert_org_priority', table_name='inventory_alerts')
    op.drop_index('idx_inventory_alert_type', table_name='inventory_alerts')
    op.drop_column('organization_settings', 'tally_username')
    op.drop_column('organization_settings', 'tally_password')
    op.drop_column('purchase_order_items', 'created_at')
    op.alter_column('service_permissions', 'description',
               existing_type=sa.TEXT(),
               type_=sa.String(length=200),
               existing_nullable=True)
    op.alter_column('service_permissions', 'created_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               type_=sa.DateTime(),
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.execute("UPDATE service_permissions SET updated_at = NOW() WHERE updated_at IS NULL")
    op.alter_column('service_permissions', 'updated_at',
                   existing_type=postgresql.TIMESTAMP(timezone=True),
                   type_=sa.DateTime(),
                   nullable=False)
    op.drop_index('idx_service_permission_module_action', table_name='service_permissions')
    op.create_index('idx_service_permission_module', 'service_permissions', ['module'], unique=False)
    op.execute("""
    DELETE FROM service_role_permissions
    WHERE permission_id IN (
        SELECT a.id
        FROM service_permissions a
        JOIN (
            SELECT MIN(ctid) as min_ctid, module, action
            FROM service_permissions
            GROUP BY module, action
            HAVING COUNT(*) > 1
        ) b ON a.module = b.module AND a.action = b.action
        WHERE a.ctid <> b.min_ctid
    );
    DELETE FROM service_permissions a USING (
        SELECT MIN(ctid) as ctid, module, action
        FROM service_permissions
        GROUP BY module, action HAVING COUNT(*) > 1
    ) b
    WHERE a.module = b.module AND a.action = b.action
    AND a.ctid <> b.ctid;
    """)
    op.create_unique_constraint('uq_service_permission_module_action', 'service_permissions', ['module', 'action'])
    op.alter_column('service_role_permissions', 'created_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               type_=sa.DateTime(),
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.drop_index('idx_service_role_permission_permission', table_name='service_role_permissions')
    op.drop_index('idx_service_role_permission_role', table_name='service_role_permissions')
    op.drop_index('ix_service_role_permissions_organization_id', table_name='service_role_permissions')
    op.drop_constraint('uq_service_role_permission', 'service_role_permissions', type_='unique')
    op.create_index(op.f('ix_service_role_permissions_permission_id'), 'service_role_permissions', ['permission_id'], unique=False)
    op.create_index(op.f('ix_service_role_permissions_role_id'), 'service_role_permissions', ['role_id'], unique=False)
    op.create_unique_constraint('uq_role_permission', 'service_role_permissions', ['role_id', 'permission_id'])
    op.drop_constraint('fk_service_role_permission_organization_id', 'service_role_permissions', type_='foreignkey')
    op.drop_column('service_role_permissions', 'organization_id')
    op.alter_column('service_roles', 'description',
               existing_type=sa.TEXT(),
               type_=sa.String(length=200),
               existing_nullable=True)
    op.alter_column('service_roles', 'created_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               type_=sa.DateTime(),
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.execute("UPDATE service_roles SET updated_at = NOW() WHERE updated_at IS NULL")
    op.alter_column('service_roles', 'updated_at',
                   existing_type=postgresql.TIMESTAMP(timezone=True),
                   type_=sa.DateTime(),
                   nullable=False)
    op.create_index(op.f('ix_service_roles_name'), 'service_roles', ['name'], unique=False)
    op.alter_column('user_service_roles', 'created_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               type_=sa.DateTime(),
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.execute("UPDATE user_service_roles SET updated_at = NOW() WHERE updated_at IS NULL")
    op.alter_column('user_service_roles', 'updated_at',
                   existing_type=postgresql.TIMESTAMP(timezone=True),
                   type_=sa.DateTime(),
                   nullable=False)
    op.drop_index('idx_user_service_role_role', table_name='user_service_roles')
    op.drop_index('idx_user_service_role_user', table_name='user_service_roles')
    op.drop_index('ix_user_service_roles_organization_id', table_name='user_service_roles')
    op.drop_index('idx_user_service_role_active', table_name='user_service_roles')
    op.create_index('idx_user_service_role_active', 'user_service_roles', ['user_id', 'is_active'], unique=False)
    op.create_index(op.f('ix_user_service_roles_role_id'), 'user_service_roles', ['role_id'], unique=False)
    op.create_index(op.f('ix_user_service_roles_user_id'), 'user_service_roles', ['user_id'], unique=False)
    op.drop_constraint('fk_user_service_role_organization_id', 'user_service_roles', type_='foreignkey')
    op.drop_column('user_service_roles', 'assigned_at')
    op.drop_column('user_service_roles', 'organization_id')
    op.execute("""
    DO $$
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_workflow_instance_org_status') THEN
            CREATE INDEX idx_workflow_instance_org_status ON workflow_instances_automation (organization_id, status);
        END IF;
    END $$;
    """)
    # ### end Alembic commands ###
def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index('idx_workflow_instance_org_status', table_name='workflow_instances_automation')
    op.add_column('user_service_roles', sa.Column('organization_id', sa.INTEGER(), autoincrement=False, nullable=False))
    op.add_column('user_service_roles', sa.Column('assigned_at', postgresql.TIMESTAMP(timezone=True), server_default=sa.text('now()'), autoincrement=False, nullable=False))
    op.create_foreign_key('fk_user_service_role_organization_id', 'user_service_roles', 'organizations', ['organization_id'], ['id'])
    op.drop_index(op.f('ix_user_service_roles_user_id'), table_name='user_service_roles')
    op.drop_index(op.f('ix_user_service_roles_role_id'), table_name='user_service_roles')
    op.drop_index('idx_user_service_role_active', table_name='user_service_roles')
    op.create_index('idx_user_service_role_active', 'user_service_roles', ['is_active'], unique=False)
    op.create_index('ix_user_service_roles_organization_id', 'user_service_roles', ['organization_id'], unique=False)
    op.create_index('idx_user_service_role_user', 'user_service_roles', ['user_id'], unique=False)
    op.create_index('idx_user_service_role_role', 'user_service_roles', ['role_id'], unique=False)
    op.alter_column('user_service_roles', 'updated_at',
               existing_type=sa.DateTime(),
               type_=postgresql.TIMESTAMP(timezone=True),
               nullable=True)
    op.alter_column('user_service_roles', 'created_at',
               existing_type=sa.DateTime(),
               type_=postgresql.TIMESTAMP(timezone=True),
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.drop_index(op.f('ix_service_roles_name'), table_name='service_roles')
    op.alter_column('service_roles', 'updated_at',
               existing_type=sa.DateTime(),
               type_=postgresql.TIMESTAMP(timezone=True),
               nullable=True)
    op.alter_column('service_roles', 'created_at',
               existing_type=sa.DateTime(),
               type_=postgresql.TIMESTAMP(timezone=True),
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('service_roles', 'description',
               existing_type=sa.String(length=200),
               type_=sa.TEXT(),
               existing_nullable=True)
    op.add_column('service_role_permissions', sa.Column('organization_id', sa.INTEGER(), autoincrement=False, nullable=False))
    op.create_foreign_key('fk_service_role_permission_organization_id', 'service_role_permissions', 'organizations', ['organization_id'], ['id'])
    op.drop_constraint('uq_role_permission', 'service_role_permissions', type_='unique')
    op.drop_index(op.f('ix_service_role_permissions_role_id'), table_name='service_role_permissions')
    op.drop_index(op.f('ix_service_role_permissions_permission_id'), table_name='service_role_permissions')
    op.create_unique_constraint('uq_service_role_permission', 'service_role_permissions', ['role_id', 'permission_id'])
    op.create_index('ix_service_role_permissions_organization_id', 'service_role_permissions', ['organization_id'], unique=False)
    op.create_index('idx_service_role_permission_role', 'service_role_permissions', ['role_id'], unique=False)
    op.create_index('idx_service_role_permission_permission', 'service_role_permissions', ['permission_id'], unique=False)
    op.alter_column('service_role_permissions', 'created_at',
               existing_type=sa.DateTime(),
               type_=postgresql.TIMESTAMP(timezone=True),
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.drop_constraint('uq_service_permission_module_action', 'service_permissions', type_='unique')
    op.drop_index('idx_service_permission_module', table_name='service_permissions')
    op.create_index('idx_service_permission_module_action', 'service_permissions', ['module', 'action'], unique=False)
    op.alter_column('service_permissions', 'updated_at',
               existing_type=sa.DateTime(),
               type_=postgresql.TIMESTAMP(timezone=True),
               nullable=True)
    op.alter_column('service_permissions', 'created_at',
               existing_type=sa.DateTime(),
               type_=postgresql.TIMESTAMP(timezone=True),
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('service_permissions', 'description',
               existing_type=sa.String(length=200),
               type_=sa.TEXT(),
               existing_nullable=True)
    op.add_column('purchase_order_items', sa.Column('created_at', postgresql.TIMESTAMP(timezone=True), server_default=sa.text('now()'), autoincrement=False, nullable=True))
    op.add_column('organization_settings', sa.Column('tally_password', sa.VARCHAR(), autoincrement=False, nullable=True))
    op.add_column('organization_settings', sa.Column('tally_username', sa.VARCHAR(), autoincrement=False, nullable=True))
    op.create_index('idx_inventory_alert_type', 'inventory_alerts', ['alert_type'], unique=False)
    op.create_index('idx_inventory_alert_org_priority', 'inventory_alerts', ['organization_id', 'priority'], unique=False)
    op.create_index('idx_inventory_alert_created_at', 'inventory_alerts', ['created_at'], unique=False)
    op.create_table('schema_version',
    sa.Column('id', sa.INTEGER(), autoincrement=True, nullable=False),
    sa.Column('version', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.PrimaryKeyConstraint('id', name='schema_version_pkey')
    )
    op.drop_index(op.f('ix_order_workflow_history_id'), table_name='order_workflow_history')
    op.drop_index('idx_workflow_history_order', table_name='order_workflow_history')
    op.drop_index('idx_workflow_history_changed_at', table_name='order_workflow_history')
    op.drop_table('order_workflow_history')
    op.drop_index(op.f('ix_order_items_id'), table_name='order_items')
    op.drop_index('idx_order_item_product', table_name='order_items')
    op.drop_index('idx_order_item_order', table_name='order_items')
    op.drop_table('order_items')
    op.drop_index(op.f('ix_orders_organization_id'), table_name='orders')
    op.drop_index(op.f('ix_orders_order_number'), table_name='orders')
    op.drop_index(op.f('ix_orders_id'), table_name='orders')
    op.drop_index('idx_order_org_status', table_name='orders')
    op.drop_index('idx_order_org_stage', table_name='orders')
    op.drop_index('idx_order_org_date', table_name='orders')
    op.drop_index('idx_order_org_customer', table_name='orders')
    op.drop_table('orders')
    op.drop_index(op.f('ix_integration_webhook_events_webhook_id'), table_name='integration_webhook_events')
    op.drop_index(op.f('ix_integration_webhook_events_received_at'), table_name='integration_webhook_events')
    op.drop_index(op.f('ix_integration_webhook_events_organization_id'), table_name='integration_webhook_events')
    op.drop_index(op.f('ix_integration_webhook_events_id'), table_name='integration_webhook_events')
    op.drop_index(op.f('ix_integration_webhook_events_event_type'), table_name='integration_webhook_events')
    op.drop_index(op.f('ix_integration_webhook_events_event_id'), table_name='integration_webhook_events')
    op.drop_index('idx_webhook_event_type', table_name='integration_webhook_events')
    op.drop_index('idx_webhook_event_processed', table_name='integration_webhook_events')
    op.drop_index('idx_webhook_event_org_webhook', table_name='integration_webhook_events')
    op.drop_table('integration_webhook_events')
    op.drop_index(op.f('ix_ab_test_results_variant_id'), table_name='ab_test_results')
    op.drop_index(op.f('ix_ab_test_results_session_id'), table_name='ab_test_results')
    op.drop_index(op.f('ix_ab_test_results_recorded_at'), table_name='ab_test_results')
    op.drop_index(op.f('ix_ab_test_results_id'), table_name='ab_test_results')
    op.drop_index(op.f('ix_ab_test_results_experiment_id'), table_name='ab_test_results')
    op.drop_index('idx_result_recorded_at', table_name='ab_test_results')
    op.drop_index('idx_result_experiment_variant', table_name='ab_test_results')
    op.drop_table('ab_test_results')
    op.drop_index(op.f('ix_ab_test_assignments_user_id'), table_name='ab_test_assignments')
    op.drop_index(op.f('ix_ab_test_assignments_session_id'), table_name='ab_test_assignments')
    op.drop_index(op.f('ix_ab_test_assignments_id'), table_name='ab_test_assignments')
    op.drop_index(op.f('ix_ab_test_assignments_experiment_id'), table_name='ab_test_assignments')
    op.drop_index('idx_assignment_experiment_user', table_name='ab_test_assignments')
    op.drop_index('idx_assignment_experiment_session', table_name='ab_test_assignments')
    op.drop_table('ab_test_assignments')
    op.drop_index(op.f('ix_streaming_metrics_window_start'), table_name='streaming_metrics')
    op.drop_index(op.f('ix_streaming_metrics_organization_id'), table_name='streaming_metrics')
    op.drop_index(op.f('ix_streaming_metrics_metric_name'), table_name='streaming_metrics')
    op.drop_index(op.f('ix_streaming_metrics_id'), table_name='streaming_metrics')
    op.drop_index('idx_metric_window', table_name='streaming_metrics')
    op.drop_index('idx_metric_org_name', table_name='streaming_metrics')
    op.drop_index('idx_metric_name_window', table_name='streaming_metrics')
    op.drop_table('streaming_metrics')
    op.drop_index(op.f('ix_streaming_events_processed'), table_name='streaming_events')
    op.drop_index(op.f('ix_streaming_events_organization_id'), table_name='streaming_events')
    op.drop_index(op.f('ix_streaming_events_id'), table_name='streaming_events')
    op.drop_index(op.f('ix_streaming_events_event_type'), table_name='streaming_events')
    op.drop_index(op.f('ix_streaming_events_event_timestamp'), table_name='streaming_events')
    op.drop_index(op.f('ix_streaming_events_data_source_id'), table_name='streaming_events')
    op.drop_index('idx_event_timestamp', table_name='streaming_events')
    op.drop_index('idx_event_source_type', table_name='streaming_events')
    op.drop_index('idx_event_processed', table_name='streaming_events')
    op.drop_table('streaming_events')
    op.drop_index(op.f('ix_streaming_alerts_triggered_at'), table_name='streaming_alerts')
    op.drop_index(op.f('ix_streaming_alerts_status'), table_name='streaming_alerts')
    op.drop_index(op.f('ix_streaming_alerts_severity'), table_name='streaming_alerts')
    op.drop_index(op.f('ix_streaming_alerts_organization_id'), table_name='streaming_alerts')
    op.drop_index(op.f('ix_streaming_alerts_id'), table_name='streaming_alerts')
    op.drop_index(op.f('ix_streaming_alerts_alert_type'), table_name='streaming_alerts')
    op.drop_index('idx_alert_triggered', table_name='streaming_alerts')
    op.drop_index('idx_alert_severity', table_name='streaming_alerts')
    op.drop_index('idx_alert_org_status', table_name='streaming_alerts')
    op.drop_table('streaming_alerts')
    op.drop_index(op.f('ix_prediction_history_prediction_timestamp'), table_name='prediction_history')
    op.drop_index(op.f('ix_prediction_history_organization_id'), table_name='prediction_history')
    op.drop_index(op.f('ix_prediction_history_model_id'), table_name='prediction_history')
    op.drop_index(op.f('ix_prediction_history_id'), table_name='prediction_history')
    op.drop_index('idx_prediction_history_org_timestamp', table_name='prediction_history')
    op.drop_index('idx_prediction_history_model_timestamp', table_name='prediction_history')
    op.drop_table('prediction_history')
    op.drop_index(op.f('ix_prediction_explanations_prediction_id'), table_name='prediction_explanations')
    op.drop_index(op.f('ix_prediction_explanations_organization_id'), table_name='prediction_explanations')
    op.drop_index(op.f('ix_prediction_explanations_model_explainability_id'), table_name='prediction_explanations')
    op.drop_index(op.f('ix_prediction_explanations_id'), table_name='prediction_explanations')
    op.drop_table('prediction_explanations')
    op.drop_index(op.f('ix_ml_model_trainings_training_name'), table_name='ml_model_trainings')
    op.drop_index(op.f('ix_ml_model_trainings_status'), table_name='ml_model_trainings')
    op.drop_index(op.f('ix_ml_model_trainings_organization_id'), table_name='ml_model_trainings')
    op.drop_index(op.f('ix_ml_model_trainings_id'), table_name='ml_model_trainings')
    op.drop_index(op.f('ix_ml_model_trainings_framework'), table_name='ml_model_trainings')
    op.drop_index(op.f('ix_ml_model_trainings_algorithm_config_id'), table_name='ml_model_trainings')
    op.drop_table('ml_model_trainings')
    op.drop_index(op.f('ix_automl_model_candidates_organization_id'), table_name='automl_model_candidates')
    op.drop_index(op.f('ix_automl_model_candidates_id'), table_name='automl_model_candidates')
    op.drop_index(op.f('ix_automl_model_candidates_automl_run_id'), table_name='automl_model_candidates')
    op.drop_table('automl_model_candidates')
    op.drop_index(op.f('ix_anomaly_detection_results_organization_id'), table_name='anomaly_detection_results')
    op.drop_index(op.f('ix_anomaly_detection_results_id'), table_name='anomaly_detection_results')
    op.drop_index(op.f('ix_anomaly_detection_results_detected_at'), table_name='anomaly_detection_results')
    op.drop_index(op.f('ix_anomaly_detection_results_anomaly_model_id'), table_name='anomaly_detection_results')
    op.drop_index('idx_anomaly_result_severity', table_name='anomaly_detection_results')
    op.drop_index('idx_anomaly_result_resolved', table_name='anomaly_detection_results')
    op.drop_index('idx_anomaly_result_org_detected', table_name='anomaly_detection_results')
    op.drop_table('anomaly_detection_results')
    op.drop_index(op.f('ix_ab_test_variants_id'), table_name='ab_test_variants')
    op.drop_index(op.f('ix_ab_test_variants_experiment_id'), table_name='ab_test_variants')
    op.drop_index('idx_variant_experiment', table_name='ab_test_variants')
    op.drop_table('ab_test_variants')
    op.drop_index(op.f('ix_streaming_data_sources_status'), table_name='streaming_data_sources')
    op.drop_index(op.f('ix_streaming_data_sources_organization_id'), table_name='streaming_data_sources')
    op.drop_index(op.f('ix_streaming_data_sources_id'), table_name='streaming_data_sources')
    op.drop_index('idx_stream_source_org_status', table_name='streaming_data_sources')
    op.drop_table('streaming_data_sources')
    op.drop_index(op.f('ix_predictive_models_organization_id'), table_name='predictive_models')
    op.drop_index(op.f('ix_predictive_models_model_type'), table_name='predictive_models')
    op.drop_index(op.f('ix_predictive_models_model_name'), table_name='predictive_models')
    op.drop_index(op.f('ix_predictive_models_id'), table_name='predictive_models')
    op.drop_index('idx_predictive_model_org_type', table_name='predictive_models')
    op.drop_index('idx_predictive_model_active', table_name='predictive_models')
    op.drop_table('predictive_models')
    op.drop_index(op.f('ix_plugin_installations_plugin_id'), table_name='plugin_installations')
    op.drop_index(op.f('ix_plugin_installations_organization_id'), table_name='plugin_installations')
    op.drop_index(op.f('ix_plugin_installations_id'), table_name='plugin_installations')
    op.drop_index('idx_installation_org_plugin', table_name='plugin_installations')
    op.drop_table('plugin_installations')
    op.drop_index(op.f('ix_plugin_hooks_plugin_id'), table_name='plugin_hooks')
    op.drop_index(op.f('ix_plugin_hooks_id'), table_name='plugin_hooks')
    op.drop_index(op.f('ix_plugin_hooks_hook_name'), table_name='plugin_hooks')
    op.drop_index('idx_hook_plugin_event', table_name='plugin_hooks')
    op.drop_index('idx_hook_name', table_name='plugin_hooks')
    op.drop_table('plugin_hooks')
    op.drop_index(op.f('ix_model_explainability_scope'), table_name='model_explainability')
    op.drop_index(op.f('ix_model_explainability_organization_id'), table_name='model_explainability')
    op.drop_index(op.f('ix_model_explainability_model_name'), table_name='model_explainability')
    op.drop_index(op.f('ix_model_explainability_model_id'), table_name='model_explainability')
    op.drop_index(op.f('ix_model_explainability_method'), table_name='model_explainability')
    op.drop_index(op.f('ix_model_explainability_id'), table_name='model_explainability')
    op.drop_table('model_explainability')
    op.drop_index(op.f('ix_ml_algorithm_configs_organization_id'), table_name='ml_algorithm_configs')
    op.drop_index(op.f('ix_ml_algorithm_configs_id'), table_name='ml_algorithm_configs')
    op.drop_index(op.f('ix_ml_algorithm_configs_framework'), table_name='ml_algorithm_configs')
    op.drop_index(op.f('ix_ml_algorithm_configs_config_name'), table_name='ml_algorithm_configs')
    op.drop_index(op.f('ix_ml_algorithm_configs_category'), table_name='ml_algorithm_configs')
    op.drop_table('ml_algorithm_configs')
    op.drop_index(op.f('ix_ledger_entries_voucher_type'), table_name='ledger_entries')
    op.drop_index(op.f('ix_ledger_entries_voucher_number'), table_name='ledger_entries')
    op.drop_index(op.f('ix_ledger_entries_organization_id'), table_name='ledger_entries')
    op.drop_index(op.f('ix_ledger_entries_id'), table_name='ledger_entries')
    op.drop_index(op.f('ix_ledger_entries_date'), table_name='ledger_entries')
    op.drop_index(op.f('ix_ledger_entries_account_id'), table_name='ledger_entries')
    op.drop_index('idx_ledger_org_date', table_name='ledger_entries')
    op.drop_index('idx_ledger_org_account', table_name='ledger_entries')
    op.drop_table('ledger_entries')
    op.drop_index(op.f('ix_integrations_status'), table_name='integrations')
    op.drop_index(op.f('ix_integrations_provider'), table_name='integrations')
    op.drop_index(op.f('ix_integrations_organization_id'), table_name='integrations')
    op.drop_index(op.f('ix_integrations_id'), table_name='integrations')
    # op.drop_index('idx_integration_org_status', table_name='integrations')
    # op.drop_index('idx_integration_org_provider', table_name='integrations')
    op.drop_table('integrations')
    op.drop_index(op.f('ix_external_data_sources_source_name'), table_name='external_data_sources')
    op.drop_index(op.f('ix_external_data_sources_organization_id'), table_name='external_data_sources')
    op.drop_index(op.f('ix_external_data_sources_id'), table_name='external_data_sources')
    op.drop_index('idx_external_data_source_org_type', table_name='external_data_sources')
    op.drop_index('idx_external_data_source_active', table_name='external_data_sources')
    op.drop_table('external_data_sources')
    op.drop_index(op.f('ix_explainability_reports_report_name'), table_name='explainability_reports')
    op.drop_index(op.f('ix_explainability_reports_organization_id'), table_name='explainability_reports')
    op.drop_index(op.f('ix_explainability_reports_id'), table_name='explainability_reports')
    op.drop_table('explainability_reports')
    op.drop_index(op.f('ix_automl_runs_task_type'), table_name='automl_runs')
    op.drop_index(op.f('ix_automl_runs_status'), table_name='automl_runs')
    op.drop_index(op.f('ix_automl_runs_run_name'), table_name='automl_runs')
    op.drop_index(op.f('ix_automl_runs_organization_id'), table_name='automl_runs')
    op.drop_index(op.f('ix_automl_runs_id'), table_name='automl_runs')
    op.drop_table('automl_runs')
    op.drop_index(op.f('ix_audit_logs_enhanced_user_id'), table_name='audit_logs_enhanced')
    op.drop_index(op.f('ix_audit_logs_enhanced_timestamp'), table_name='audit_logs_enhanced')
    op.drop_index(op.f('ix_audit_logs_enhanced_organization_id'), table_name='audit_logs_enhanced')
    op.drop_index(op.f('ix_audit_logs_enhanced_id'), table_name='audit_logs_enhanced')
    op.drop_index(op.f('ix_audit_logs_enhanced_entity_type'), table_name='audit_logs_enhanced')
    op.drop_index(op.f('ix_audit_logs_enhanced_entity_id'), table_name='audit_logs_enhanced')
    op.drop_index(op.f('ix_audit_logs_enhanced_action'), table_name='audit_logs_enhanced')
    op.drop_index('idx_audit_user_timestamp', table_name='audit_logs_enhanced')
    # op.drop_index('idx_audit_org_timestamp', table_name='audit_logs_enhanced')
    op.drop_index('idx_audit_org_entity', table_name='audit_logs_enhanced')
    op.drop_index('idx_audit_org_action', table_name='audit_logs_enhanced')
    op.drop_index('idx_audit_automation', table_name='audit_logs_enhanced')
    op.drop_index('idx_audit_ai_agent', table_name='audit_logs_enhanced')
    op.drop_index('idx_audit_actor', table_name='audit_logs_enhanced')
    op.drop_table('audit_logs_enhanced')
    op.drop_index(op.f('ix_audit_log_views_organization_id'), table_name='audit_log_views')
    op.drop_index(op.f('ix_audit_log_views_id'), table_name='audit_log_views')
    op.drop_index('idx_audit_view_user', table_name='audit_log_views')
    op.drop_index('idx_audit_view_org', table_name='audit_log_views')
    op.drop_table('audit_log_views')
    op.drop_index(op.f('ix_audit_log_exports_organization_id'), table_name='audit_log_exports')
    op.drop_index(op.f('ix_audit_log_exports_id'), table_name='audit_log_exports')
    op.drop_index('idx_audit_export_user', table_name='audit_log_exports')
    op.drop_index('idx_audit_export_org_status', table_name='audit_log_exports')
    op.drop_table('audit_log_exports')
    op.drop_index(op.f('ix_anomaly_detection_models_organization_id'), table_name='anomaly_detection_models')
    op.drop_index(op.f('ix_anomaly_detection_models_id'), table_name='anomaly_detection_models')
    op.drop_index(op.f('ix_anomaly_detection_models_detection_name'), table_name='anomaly_detection_models')
    op.drop_index(op.f('ix_anomaly_detection_models_anomaly_type'), table_name='anomaly_detection_models')
    op.drop_index('idx_anomaly_model_org_type', table_name='anomaly_detection_models')
    op.drop_index('idx_anomaly_model_active', table_name='anomaly_detection_models')
    op.drop_table('anomaly_detection_models')
    op.drop_index(op.f('ix_ai_agent_interactions_user_id'), table_name='ai_agent_interactions')
    op.drop_index(op.f('ix_ai_agent_interactions_session_id'), table_name='ai_agent_interactions')
    op.drop_index(op.f('ix_ai_agent_interactions_organization_id'), table_name='ai_agent_interactions')
    op.drop_index(op.f('ix_ai_agent_interactions_id'), table_name='ai_agent_interactions')
    op.drop_index(op.f('ix_ai_agent_interactions_agent_id'), table_name='ai_agent_interactions')
    op.drop_index('idx_ai_interaction_session', table_name='ai_agent_interactions')
    op.drop_index('idx_ai_interaction_org_agent', table_name='ai_agent_interactions')
    op.drop_index('idx_ai_interaction_created', table_name='ai_agent_interactions')
    op.drop_table('ai_agent_interactions')
    op.drop_index(op.f('ix_ai_agent_capabilities_id'), table_name='ai_agent_capabilities')
    op.drop_index(op.f('ix_ai_agent_capabilities_agent_id'), table_name='ai_agent_capabilities')
    op.drop_index('idx_ai_capability_agent', table_name='ai_agent_capabilities')
    op.drop_table('ai_agent_capabilities')
    op.drop_index(op.f('ix_ab_test_experiments_status'), table_name='ab_test_experiments')
    op.drop_index(op.f('ix_ab_test_experiments_organization_id'), table_name='ab_test_experiments')
    op.drop_index(op.f('ix_ab_test_experiments_id'), table_name='ab_test_experiments')
    op.drop_index('idx_ab_test_org_status', table_name='ab_test_experiments')
    op.drop_index('idx_ab_test_dates', table_name='ab_test_experiments')
    op.drop_table('ab_test_experiments')
    op.drop_index(op.f('ix_plugins_slug'), table_name='plugins')
    op.drop_index(op.f('ix_plugins_organization_id'), table_name='plugins')
    op.drop_index(op.f('ix_plugins_name'), table_name='plugins')
    op.drop_index(op.f('ix_plugins_id'), table_name='plugins')
    op.drop_index('idx_plugin_status', table_name='plugins')
    op.drop_index('idx_plugin_scope', table_name='plugins')
    op.drop_index('idx_plugin_org_type', table_name='plugins')
    op.drop_table('plugins')
    op.drop_index(op.f('ix_ledger_summaries_summary_date'), table_name='ledger_summaries')
    op.drop_index(op.f('ix_ledger_summaries_organization_id'), table_name='ledger_summaries')
    op.drop_index(op.f('ix_ledger_summaries_id'), table_name='ledger_summaries')
    op.drop_table('ledger_summaries')
    op.drop_index(op.f('ix_ai_agents_organization_id'), table_name='ai_agents')
    op.drop_index(op.f('ix_ai_agents_name'), table_name='ai_agents')
    op.drop_index(op.f('ix_ai_agents_id'), table_name='ai_agents')
    op.drop_index('idx_ai_agent_status', table_name='ai_agents')
    op.drop_index('idx_ai_agent_org_type', table_name='ai_agents')
    op.drop_table('ai_agents')
    op.drop_index(op.f('ix_plugin_registry_slug'), table_name='plugin_registry')
    op.drop_index(op.f('ix_plugin_registry_id'), table_name='plugin_registry')
    op.drop_index(op.f('ix_plugin_registry_category'), table_name='plugin_registry')
    op.drop_index('idx_registry_verified', table_name='plugin_registry')
    op.drop_index('idx_registry_category', table_name='plugin_registry')
    op.drop_table('plugin_registry')
    # ### end Alembic commands ###
