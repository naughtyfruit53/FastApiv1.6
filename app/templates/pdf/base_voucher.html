<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ voucher.voucher_type|title }} Voucher - {{ voucher.voucher_number }}</title>
    <style>
        /* Page / print */
        @page { size: A4; margin: 0 }
        html, body { height: 100%; margin: 0; padding: 0; background: #fff; font-family: "Segoe UI", Roboto, Arial, sans-serif; font-size: 11px; color: #111 }
        .preview-wrap { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 0; background: #fff; }
        .a4 { width: 210mm; height: 297mm; background: #fff; position: relative; box-sizing: border-box; overflow: hidden; box-shadow: none; }
        
        /* Voucher title */
        .voucher-title {
            position: absolute;
            top: 0.5cm;
            left: 0;
            right: 0;
            text-align: center;
            font-weight: 700;
            font-size: 18pt;
            line-height: 1;
            z-index: 20;
        }
        /* framed voucher box inside margins */
        .voucher-box {
            position: absolute;
            left: 1.25cm;
            top: 1.5cm;
            right: 0.75cm;
            bottom: 0.5cm;
            border: 3px solid #222;
            box-sizing: border-box;
            padding: 0;
            background: #fff;
            overflow: auto;
            display: flex;
            flex-direction: column;
        }
        /* 2x2 grid (shared borders, no gaps) */
        .blocks-grid { width: 100%; border-collapse: collapse; table-layout: fixed; margin: 0 }
        .blocks-grid td {
            border: 1px solid #222;
            padding: 0;
            box-sizing: border-box;
            vertical-align: top;
            height: 6.9em;
            line-height: 1.15em;
            font-size: 11px;
        }
        .block-inner { padding: 2px; box-sizing: border-box; } /* small inner padding */
        /* --- TOP-RIGHT meta: remove outside table border; only row separators and the parent block border remain --- */
        .meta-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            margin: 0;
            border: none; /* ensure no outside border */
        }
        .meta-table tr { border-bottom: 1px solid #222; }
        .meta-table tr:last-child { border-bottom: none; }
        .meta-table td {
            padding: 2px; /* 2px padding as requested */
            font-size: 11px; /* matches overall font */
            line-height: 1;
            vertical-align: middle;
            box-sizing: border-box;
            height: 18px; /* compact row height similar to product rows */
            overflow: hidden;
            border: none; /* Explicitly remove any td borders */
        }
        .meta-table .label { width: 64%; text-align: left; font-weight: 600; padding-left: 6px; white-space: nowrap; }
        .meta-table .value { width: 36%; text-align: right; padding-right: 6px; box-sizing: border-box; border-left: 1px solid #222; }
        /* ITEMS TABLE */
        .items-table { width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 11px; margin: 0 }
        .items-table thead th {
            border-left: 1px solid #222;
            border-right: 1px solid #222;
            border-bottom: 1px solid #222;
            border-top: none; /* grid bottom border acts as separator */
            padding: 2px 6px;
            background: #f6f6f6;
            font-weight: 700;
            text-align: left;
            font-size: 13px; /* table titles font size requested */
            height: 22px;
        }
        .items-table tbody td {
            border-left: 1px solid #222;
            border-right: 1px solid #222;
            border-bottom: 1px solid #222;
            padding: 2px 6px;
            vertical-align: middle;
            height: 18px;
            overflow: hidden;
        }
        .items-table thead th:first-child, .items-table tbody td:first-child { border-left: 1px solid #222; }
        .items-table thead th:last-child, .items-table tbody td:last-child { border-right: 1px solid #222; }
        .blank-row td { height: 18px; }
        /* totals row inside same table */
        .items-table tfoot td {
            border-left: 1px solid #222;
            border-right: 1px solid #222;
            border-bottom: 1px solid #222;
            padding: 2px 6px;
            background: #fafafa;
            vertical-align: middle;
            height: 20px;
            font-size: 11px;
        }
        .items-table tfoot .label-cell { font-weight: 700; padding-left: 6px; }
        .items-table tfoot .num-cell { text-align: right; font-weight: 700; padding-right: 6px; }
        /* Totals & Bank area directly below items table (single-border look) */
        .totals-bank {
            width: 100%;
            border-collapse: collapse;
            border-left: 1px solid #222;
            border-right: 1px solid #222;
            border-bottom: 1px solid #222;
            box-sizing: border-box;
        }
        .totals-bank td {
            border-top: 1px solid #222;
            vertical-align: top;
            padding: 6px;
        }
        .totals-bank .bank { border-right: 1px solid #222; font-size: 11px; min-height: 120px; }
        .totals { font-size: 11px; }
        .totals table { width: 100%; border-collapse: collapse; }
        .totals td { padding: 4px 6px; border-bottom: 1px solid #e6e6e6; vertical-align: middle; height: 18px; font-size: 11px; }
        .totals tr:last-child td { border-bottom: none; font-weight: 700; font-size: 13px; }
        /* Full-width amount-in-words block (no gap) */
        .amount-words {
            box-sizing: border-box;
            border-left: 1px solid #222;
            border-right: 1px solid #222;
            border-bottom: 1px solid #222;
            padding: 6px;
            min-height: 28px;
            display: flex;
            align-items: center;
            font-weight: 600;
            font-size: 11px;
            flex-wrap: wrap;
        }
        .amount-words .label { font-weight: 700; margin-right: 8px; font-size: 11px; }
        .amount-words .words { margin-left: 8px; white-space: normal; word-wrap: break-word; }
        /* TERMS block: 4 stacked rows, no gaps */
        .terms { box-sizing: border-box; border-left: 1px solid #222; border-right: 1px solid #222; border-bottom: 1px solid #222; font-size: 11px; }
        .terms table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .terms td { padding: 6px; border-bottom: 1px solid #222; height: 18px; font-size: 11px; }
        .terms tr:last-child td { border-bottom: none; }
        /* Column width helpers */
        .col-sr { width: 6%; text-align: center }
        .col-product { width: 34%; padding-left: 6px }
        .col-hsn { width: 12%; text-align: center }
        .col-qty { width: 8%; text-align: right; padding-right: 6px }
        .col-rate { width: 10%; text-align: right; padding-right: 6px }
        .col-gst { width: 8%; text-align: right; padding-right: 6px }
        .col-disc { width: 8%; text-align: right; padding-right: 6px }
        .col-line { width: 12%; text-align: right; padding-right: 6px }
        .num { font-variant-numeric: tabular-nums; }
        .muted { color: #555; }
        .right { text-align: right; }
        @media print {
            body { background: #fff }
            .preview-wrap { padding: 0 }
            .a4 { box-shadow: none; margin: 0 }
        }
    </style>
</head>
<body>
    <div class="preview-wrap">
        <div class="a4" id="page-a4">
            <div class="voucher-title">
                {{ voucher.voucher_type|upper }}
                {% if voucher.status and voucher.status != 'draft' %}
                <span style="font-size: 9px; background-color: #f39c12; color: white; padding: 3px 8px; border-radius: 3px; text-transform: uppercase;">{{ voucher.status }}</span>
                {% endif %}
            </div>
            <div class="voucher-box">
                <!-- 2x2 grid -->
                <table class="blocks-grid" role="grid" aria-label="Top 4 blocks grid">
                    <tbody>
                        <tr>
                            <!-- TOP LEFT: Company details -->
                            <td id="block-1">
                                <div class="block-inner" style="display: flex; align-items: flex-start;">
                                    {% if company.logo_url %}
                                    <img src="{{ company.logo_url }}" style="width: 50px; height: 50px; margin-right: 10px; object-fit: contain;">
                                    {% endif %}
                                    <div>
                                        <div style="font-weight:700; font-size:12px;">{{ company.name|upper }}</div>
                                        <div>{{ company.address1 }}{% if company.address2 %}, {{ company.address2 }}{% endif %}</div>
                                        <div>{{ company.city }}{% if company.state %}, {{ company.state }}{% endif %}{% if company.pin_code %}, {{ company.pin_code }}{% endif %}</div>
                                        {% if company.gst_number %}<div>GSTIN: {{ company.gst_number }}</div>{% endif %}
                                        {% if company.contact_number %}<div>Contact: {{ company.contact_number }}</div>{% endif %}
                                        {% if company.pan_number %}<div>Company’s PAN: {{ company.pan_number }}</div>{% endif %}
                                    </div>
                                </div>
                            </td>
                            <!-- TOP RIGHT: meta table (no outer border, row separators only) -->
                            <td id="block-2">
                                <div class="block-inner">
                                    <table class="meta-table" role="table" aria-label="Top-right meta (label/value rows)">
                                        <tbody>
                                            {% block voucher_meta %}
                                            <tr><td class="label">Date</td><td class="value">{{ voucher.date|format_date }}</td></tr>
                                            <tr><td class="label">Voucher Number</td><td class="value">{{ voucher.voucher_number|default('N/A') }}</td></tr>
                                            {% if voucher.reference_number %}<tr><td class="label">Ref Number</td><td class="value">{{ voucher.reference_number }}</td></tr>{% endif %}
                                            {% endblock %}
                                        </tbody>
                                    </table>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <!-- BOTTOM LEFT: Bill To (Party: Vendor/Customer) -->
                            <td id="block-3">
                                <div class="block-inner">
                                    {% set party = voucher.vendor or voucher.customer %}
                                    {% if party %}
                                    <div style="font-weight:700;">{{ 'Vendor' if voucher.vendor else 'Customer' }} Details</div>
                                    <div style="font-weight:600;">{{ party.name|upper }}</div>
                                    <div>{{ party.address }}{% if party.city %}, {{ party.city }}{% endif %}{% if party.state %}, {{ party.state }}{% endif %}{% if party.pin_code %} - {{ party.pin_code }}{% endif %}</div>
                                    {% if party.contact_number %}<div>Contact: {{ party.contact_number }}</div>{% endif %}
                                    {% if party.email %}<div>Email: {{ party.email }}</div>{% endif %}
                                    {% if party.gst_number %}<div>GSTIN/UIN: {{ party.gst_number }}</div>{% endif %}
                                    {% if party.pan_number %}<div>PAN/IT No: {{ party.pan_number }}</div>{% endif %}
                                    {% else %}
                                    <div style="font-weight:700;">No Party Details</div>
                                    {% endif %}
                                </div>
                            </td>
                            <!-- BOTTOM RIGHT: Ship To (placeholder if different) -->
                            <td id="block-4">
                                <div class="block-inner">
                                    <div style="font-weight:700;">Ship To</div>
                                    {% if voucher.shipping_address %}
                                    <div style="font-weight:600;">{{ voucher.shipping_address.name|default('') }}</div>
                                    <div>{{ voucher.shipping_address.address }}</div>
                                    <div>{{ voucher.shipping_address.city }}{% if voucher.shipping_address.state %}, {{ voucher.shipping_address.state }}{% endif %}{% if voucher.shipping_address.pin_code %} - {{ voucher.shipping_address.pin_code }}{% endif %}</div>
                                    {% if voucher.shipping_address.contact %}<div>Contact: {{ voucher.shipping_address.contact }}</div>{% endif %}
                                    {% if voucher.shipping_address.email %}<div>Email: {{ voucher.shipping_address.email }}</div>{% endif %}
                                    {% if voucher.shipping_address.gst_number %}<div>GSTIN/UIN: {{ voucher.shipping_address.gst_number }}</div>{% endif %}
                                    {% if voucher.shipping_address.pan_number %}<div>PAN/IT No: {{ voucher.shipping_address.pan_number }}</div>{% endif %}
                                    {% else %}
                                    {% if party %}
                                    <div style="font-weight:600;">{{ party.name|upper }}</div>
                                    <div>{{ party.address }}{% if party.city %}, {{ party.city }}{% endif %}{% if party.state %}, {{ party.state }}{% endif %}{% if party.pin_code %} - {{ party.pin_code }}{% endif %}</div>
                                    {% if party.contact_number %}<div>Contact: {{ party.contact_number }}</div>{% endif %}
                                    {% if party.email %}<div>Email: {{ party.email }}</div>{% endif %}
                                    {% if party.gst_number %}<div>GSTIN/UIN: {{ party.gst_number }}</div>{% endif %}
                                    {% if party.pan_number %}<div>PAN/IT No: {{ party.pan_number }}</div>{% endif %}
                                    {% else %}
                                    <div style="font-weight:600;">(Same as Bill To)</div>
                                    {% endif %}
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <!-- Items table with blank row & totals -->
                <table class="items-table" role="table" aria-label="Items">
                    <thead>
                        <tr>
                            <th class="col-sr">Sr No.</th>
                            <th class="col-product">Product Name</th>
                            <th class="col-hsn">HSN Code</th>
                            <th class="col-qty">Quantity</th>
                            <th class="col-rate">Rate</th>
                            {% if line_discount_enabled %}<th class="col-disc">Disc</th>{% endif %}
                            <th class="col-gst">GST%</th>
                            <th class="col-line">Line Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if items|length > 0 %}
                        {% for item in items %}
                        <tr>
                            <td class="col-sr">{{ loop.index }}</td>
                            <td class="col-product">{{ item.product_name|default(item.description, 'Product') }}{% if item.description and item.product_name != item.description %}<br><small>{{ item.description }}</small>{% endif %}</td>
                            <td class="col-hsn">{{ item.hsn_code|default('-') }}</td>
                            <td class="col-qty num">{{ "%.2f"|format(item.quantity|float) }} {{ item.unit|default('Nos') }}</td>
                            <td class="col-rate num">{{ item.unit_price|format_currency(show_symbol=True) }}</td>
                            {% if line_discount_enabled %}
                            <td class="col-disc num">
                                {% if item.discount_percentage > 0 %}
                                    {{ item.discount_percentage }}%
                                {% elif item.discount_amount > 0 %}
                                    {{ item.discount_amount|format_currency(show_symbol=True) }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            {% endif %}
                            <td class="col-gst num">{{ item.gst_rate|format_percentage }}%</td>
                            <td class="col-line num">{{ item.total_amount|format_currency(show_symbol=True) }}</td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="{% if line_discount_enabled %}8{% else %}7{% endif %}" class="text-center">No items available</td>
                        </tr>
                        {% endif %}
                        <!-- blank bordered row before totals -->
                        <tr class="blank-row"><td></td><td></td><td></td><td></td><td></td>{% if line_discount_enabled %}<td></td>{% endif %}<td></td><td></td></tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td></td>
                            <td class="label-cell">Totals</td>
                            <td></td>
                            <td class="num num-cell" style="text-align:right;">{{ total_quantity|default(0) }}</td>
                            <td></td>
                            {% if line_discount_enabled %}<td></td>{% endif %}
                            <td></td>
                            <td class="num num-cell" style="text-align:right;">{{ subtotal|format_currency(show_symbol=True) }}</td>
                        </tr>
                    </tfoot>
                </table>
                <!-- Totals & Bank area -->
                <table class="totals-bank" role="region" aria-label="Bank and Totals">
                    <tr>
                        <td class="bank">
                            <div style="font-weight:700;">Company’s Bank Details</div>
                            {% if company.bank_details %}
                            <div>A/c Holder’s Name : {{ company.bank_details.holder_name|default(company.name) }}</div>
                            <div>Bank Name : {{ company.bank_details.bank_name }}</div>
                            <div>A/c No. : {{ company.bank_details.account_number }}</div>
                            <div>Branch & IFS Code : {{ company.bank_details.branch }} & {{ company.bank_details.ifsc }}</div>
                            {% endif %}
                            {% if company.pan_number %}<div style="font-size:11px; color:#555; margin-top:4px;">Company’s PAN : {{ company.pan_number }}</div>{% endif %}
                        </td>
                        <td class="totals">
                            <table>
                                <tbody>
                                    <tr><td class="muted">Taxable Value</td><td class="right num">{{ total_taxable|format_currency(show_symbol=True) }}</td></tr>
                                    {% if is_interstate %}
                                    <tr><td class="muted">OUTPUT IGST @ {{ voucher.gst_rate|default(18) }}%</td><td class="right num">{{ total_igst|format_currency(show_symbol=True) }}</td></tr>
                                    {% else %}
                                    <tr><td class="muted">OUTPUT CGST @ {{ voucher.gst_rate|default(9) }}%</td><td class="right num">{{ total_cgst|format_currency(show_symbol=True) }}</td></tr>
                                    <tr><td class="muted">OUTPUT SGST @ {{ voucher.gst_rate|default(9) }}%</td><td class="right num">{{ total_sgst|format_currency(show_symbol=True) }}</td></tr>
                                    {% endif %}
                                    <tr><td class="muted">Round Off</td><td class="right num">{{ round_off|format_currency(show_symbol=True) }}</td></tr>
                                    <tr><td style="font-weight:700">Total</td><td class="right num">{{ grand_total|format_currency(show_symbol=True) }}</td></tr>
                                </tbody>
                            </table>
                        </td>
                    </tr>
                </table>
                <!-- Amount in words -->
                {% block amount_words_block %}
                <div class="amount-words">
                    <div class="label">Total (In Words) :</div>
                    <div class="words">{{ amount_in_words }}</div>
                </div>
                {% endblock %}
                <!-- Terms -->
                {% block terms_block %}
                <div class="terms">
                    <table>
                        <tbody>
                            {% if voucher.terms_conditions %}
                            {% for term in voucher.terms_conditions.split('\n')|slice(4) %}
                            <tr><td>{{ loop.index }}. {{ term|trim }}</td></tr>
                            {% endfor %}
                            {% else %}
                            <tr><td>1. TERMS AND CONDITIONS - NO RETURN NO EXCHANGE.</td></tr>
                            <tr><td>2. Late payments will be subject to an interest charge of 18%.</td></tr>
                            <tr><td>3. Goods once sold will not be taken back without prior written consent.</td></tr>
                            <tr><td>4. SUBJECT TO PANVEL JURISDICTION.</td></tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                {% endblock %}
                <!-- Signatures -->
                {% block signatures_block %}
                <div class="signatures" style="margin-top: auto; box-sizing: border-box; border-left: 1px solid #222; border-right: 1px solid #222; border-bottom: 1px solid #222; display: flex; justify-content: flex-end; padding: 10px; font-size: 11px;">
                    <div style="width: 100%; text-align: right;">
                        <div>For {{ company.name|upper }}</div>
                        <div style="height: 20px;"></div>
                        <div>_______________________</div>
                        <div>Authorized Signature</div>
                    </div>
                </div>
                {% endblock %}
                {% block voucher_specific_footer %}{% endblock %}
            </div>
        </div>
    </div>
</body>
</html>